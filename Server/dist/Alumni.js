/*! For license information please see Alumni.js.LICENSE */
!function(e){var a={};function t(r){if(a[r])return a[r].exports;var s=a[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,t),s.l=!0,s.exports}t.m=e,t.c=a,t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:r})},t.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)},t.p="C:\\Users\\denis.stajduhar\\Desktop\\LAMA\\_Alumni\\AlumniNode\\dist",t.w={},t(t.s="./src/server.js")}({"./src/api.js":function(e,a,t){var r=t("express"),s=(t("request"),t("./src/kripto.js"),r.Router());t("./src/db.js"),t("./src/jwt/jwt.js"),t("fs");s.get("/test",function(e,a){a.send({message:"OK"})}),e.exports=s},"./src/api/administracija.js":function(e,a,t){const r=t("express").Router(),{TYPES:s}=t("tedious"),o=t("./src/db.js"),{simpleDbResolve:n,handleRequestUser:i}=t("./src/services/app.service.js");r.get("/users",async function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Administracija.spApplicationUsers_Select",t,a);o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.put("/statusKorisnika",async function(e,a){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Administracija.spStatusKorisnika_Update",r,a);u.addParameter("PkUsera",s.Int,e.body.PkUsera),u.addParameter("StatusKorisnika",s.Int,e.body.StatusKorisnika),u.addParameter("UserPromjena",s.NVarChar,t.ImePrezimeUsera),u.addParameter("PkUserPromjena",s.Int,t.PkUsera),u.addParameter("RowVersion",s.NVarChar,e.body.RowVersion),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}),r.put("/userApplicationGroup",async function(e,a){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Administracija.spSetUserGroup",r,a);u.addParameter("PkUsera",s.Int,e.body.PkUsera),u.addParameter("PkGrupa",s.Int,e.body.PkGrupa),u.addParameter("UserUnos",s.NVarChar,t.ImePrezimeUsera),u.addParameter("PkUseraUnos",s.Int,t.PkUsera),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}),r.put("/userClaims",async function(e,a){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Administracija.spUserClaims_Update",r,a);u.addParameter("PkUsera",s.Int,e.body.PkUsera),u.addParameter("Claims",s.NVarChar,JSON.stringify(e.body.Claims)),u.addParameter("PkUserPromjena",s.Int,t.PkUsera),u.addParameter("UserPromjena",s.NVarChar,t.ImePrezimeUsera),u.addParameter("RowVersion",s.NVarChar,e.body.RowVersion),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}),r.put("/userVrstaClanstva",async function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Administracija.spVrstaClanstva_Update",t,a);r.addParameter("PkUsera",s.Int,e.body.PkUsera),r.addParameter("PkVrstaClanstva",s.Int,e.body.PkVrstaClanstva),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/LogOsobniPodaci",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Logs.spLogOsobniPodaci_Select",t,a);r.addParameter("PkUsera",s.Int,e.query.PkUsera),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),e.exports={administracijaRouter:r}},"./src/api/ankete.js":function(e,a,t){const r=t("express").Router(),{TYPES:s}=t("tedious"),o=t("./src/db.js"),{simpleDbResolve:n,handleRequestUser:i,exists:u,constructConnection:c,makeObservableConnection:d,makeObservableConnectionWithOutput:l,groupFlatProperies:P,flatten:m,decryptIfEncrypted:k,stringToSentence:p,hasClaim:g}=t("./src/services/app.service.js"),{forkJoin:b,from:f,first:D,mergeMap:j,combineLatest:C,take:E,concat:v,last:A,of:I}=t("rxjs"),{sendAnketaLinkMail:N}=t("./src/mail/mail.js"),{tryDecryptOrReturnInput:y}=t("./src/kripto.js"),{insertPredlozakWithOutput:S,updatePredlozakWithOutput:U,insertPitanjePredlozak:O,groupStats:h,fetchAnketaStatistika:R,fetchAnketaStatistikaPitanja:_}=t("./src/services/ankete.service.js");r.get("/predlosci",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Ankete.spPredlozak_select",t,a);u(e.query.PkPredlozak)&&r.addParameter("PkPredlozak",s.Int,e.query.PkPredlozak),u(e.query.PkUsera)&&r.addParameter("PkUsera",s.Int,e.query.PkUsera),u(e.query.skip)&&r.addParameter("skip",s.Int,e.query.skip),u(e.query.take)&&r.addParameter("take",s.Int,e.query.take),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/ankete",async function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Ankete.spAnketa_select",t,a);u(e.query.PkAnketa)&&r.addParameter("PkAnketa",s.Int,e.query.PkAnketa),u(e.query.PkUsera)&&r.addParameter("PkUsera",s.Int,e.query.PkUsera),u(e.query.skip)&&r.addParameter("skip",s.Int,e.query.skip),u(e.query.take)&&r.addParameter("take",s.Int,e.query.take),u(e.query.IsPublic)&&r.addParameter("IsPublic",s.Int,+e.query.IsPublic),o.execStoredProcFromNode(r,t,a,(e,t,r)=>"OK"==e?a.status(200).send(r.map(e=>P(e))):a.status(500).send({message:"STD:INVALID_REQUEST"}))}),r.get("/predlozak/templating",function(e,a){const{PkPredlozak:t}=e.query,r=({predlozak:e=null,pitanja:t=null})=>{const r=o.createConnection(a.locals.currDatabase),s=o.createRequest("AP.spPitanjeTip_select",r,a);return o.execStoredProcFromNode(s,r,a,(r,s,o)=>{"OK"==r?a.status(200).send({predlozak:e,pitanja:t,tipoviPitanja:o}):a.status(500).send({message:"STD:INVALID_REQUEST"})})};if(!u(t))return r({});const n=["Ankete.spPredlozak_select","Ankete.spPitanjaZaPredlozak_select"].map(e=>{const{request:r,conn:n}=c(e,a.locals.currDatabase,a,o);return r.addParameter("PkPredlozak",s.Int,t),f(new Promise(e=>{o.execStoredProcFromNode(r,n,a,(a,t,r)=>{"OK"==a&&e(r),e([])})}))}),i=b(n).subscribe({next:([[e],t])=>{if(!e)return a.status(500).send({message:"STD:INVALID_REQUEST"});if(!t.length)return r({predlozak:e,pitanja:[]});const n=t.map(e=>{const{PkPitanje:t}=e,r=o.createConnection(a.locals.currDatabase),n=o.createRequest("Ankete.spOdgovorZaPitanje_select",r,a);return n.addParameter("PkPitanje",s.Int,t),f(new Promise(e=>{o.execStoredProcFromNode(n,r,a,(a,t,r)=>{"OK"==a&&e(r),e([])})}))}),i=b(n).subscribe({next:a=>{const s=e=>Number(e.trim());return r({predlozak:e,pitanja:t.map(e=>({...e,...{PitanjeRedoslijed:s(e.PitanjeRedoslijed)},odgovori:((e,a)=>{for(const t of e)if(t.find(e=>e.PkPitanje===a))return t.map(e=>({...e,...{OdgovorRedoslijed:s(e.OdgovorRedoslijed)}}))})(a,e.PkPitanje)}))})},error:e=>{a.status(500).send({...e,message:"STD:INVALID_REQUEST"})},complete:()=>{setTimeout(()=>{i.unsubscribe()})}})},error:e=>{a.status(500).send({...e,message:"STD:INVALID_REQUEST"})},complete:()=>{setTimeout(()=>{i.unsubscribe()})}})}),r.get("/anketa/solved/check",async(e,a)=>{const t=await i(e,a),{PkAnketa:r}=e.query;return(({PkAnketa:e,PkUser:t})=>{const{request:r,conn:n}=c("Ankete.spAnketaUser_select",a.locals.currDatabase,a,o);return r.addParameter("PkAnketa",s.Int,e),r.addParameter("PkUser",s.Int,t),d(r,n,a,o)})({PkAnketa:r,PkUser:t.PkUsera}).pipe(D()).subscribe({next:([e])=>{e?a.status(200).send({isSolved:!!e.UserPristupioAnketiDaNe,eligible:!0}):a.status(200).send({isSolved:!1,eligible:!1})},error:e=>{a.status(200).send(e)}})}),r.get("/anketa/statistika",async function(e,a){const{PkAnketa:t,PkPredlozak:r}=e.query,s={...t&&{PkAnketa:t},...r&&{PkPredlozak:r}};b([R({...s,res:a,db:o}),_({...s,res:a,db:o})]).pipe(D()).subscribe(([[e],t])=>{const r=h(t);a.send({anketaStats:e,pitanjaStats:r})})}),r.post("/predlozak/copy",async function(e,a){if(!await g({modul:"Ankete",claim:"Predlozak"},e))return a.status(401).send({message:"STD:UNATHORIZED_ACCES"});const t=await i(e,a),{predlozak:r}=e.body,{predlozak:s,pitanja:n,tipoviPitanja:u}=r;S({predlozak:s,db:o,res:a,user:t}).pipe(D()).subscribe(({PkPredlozak:e})=>{b(n.map(r=>O({PkPitanje:r.PkPitanje,PkPredlozak:e,db:o,res:a,user:t,pitanje:r}))).pipe(D()).subscribe(e=>{a.send({message:"OK"})})})}),r.post("/predlozak/templating",async function(e,a){if(!await g({modul:"Ankete",claim:"Predlozak"},e))return a.status(401).send({message:"STD:UNATHORIZED_ACCES"});const t=await i(e,a),{predlozak:r}=e.body,{PkPredlozak:s}=r;return s?U({predlozak:r,PkPredlozak:s,db:o,user:t,res:a}).pipe(D()).subscribe(({PkPredlozak:e})=>{a.status(200).send({PkPredlozak:e})}):S({predlozak:r,db:o,res:a,user:t}).pipe(D()).subscribe(({PkPredlozak:e})=>{a.status(200).send({PkPredlozak:e})})}),r.post("/anketa/solved",async function(e,a){const t=await i(e,a),{pitanja:r,PkAnketa:n,PkPredlozak:P,anketa:m}=e.body,k=({PkAnketaUserPitanje:e,Odgovor:t})=>{const{request:r,conn:n}=c("Ankete.spAnketaUserSolvedQuestionOdgovor_insert",a.locals.currDatabase,a,o);if(r.addParameter("PkAnketaUserPitanje",s.Int,e),t){const{PkOdgovor:e,OdgovorTekst:a}=t;e&&r.addParameter("PkOdgovor",s.Int,e),r.addParameter("UserOdgovorTekst",s.NVarChar,a)}return r.addOutputParameter("PkAnketaUserPitanjeOdgovor",s.Int,null),d(r,n,a,o)},g=({PkPitanje:e,PkOdgovor:t,OdgovorTekst:r})=>{const{request:i,conn:d}=c("Ankete.[spStatistikaAnketaPitanjaOdgovor_upsert]",a.locals.currDatabase,a,o);return i.addParameter("PkAnketa",s.Int,n),i.addParameter("PkPredlozak",s.Int,P),i.addParameter("PkPitanje",s.Int,e),!u(t)&&i.addParameter("AnonimniOdgovorTekst",s.NVarChar,p(r)),i.addParameter("PkOdgovor",s.Int,t),i.addOutputParameter("PkStatistikaAnketaUserPitanjeOdgovor",s.Int,null),l(i,d,a,o,"PkStatistikaAnketaUserPitanjeOdgovor")},f=({PkAnketaUser:e,pitanje:t})=>{const{PkPitanje:r,Odgovor:n}=t,i=u(n)?1:0;if(i)if(Array.isArray(n))b(n.map(e=>g({PkPitanje:r,PkOdgovor:e.PkOdgovor,OdgovorTekst:e.OdgovorTekst}))).pipe(D()).subscribe(e=>{});else{const{PkOdgovor:e,OdgovorTekst:a}=n;g({PkPitanje:r,PkOdgovor:e,OdgovorTekst:a}).pipe(D()).subscribe(({PkStatistikaAnketaUserPitanjeOdgovor:e})=>{})}if(e){const{request:t,conn:u}=c("Ankete.spAnketaUserSolvedQuestion_insert",a.locals.currDatabase,a,o);return t.addParameter("PkAnketaUser",s.Int,e),t.addParameter("PkPitanje",s.Int,r),t.addParameter("UserOdgovorioNaPitanjeDaNe",s.Int,i),t.addOutputParameter("PkAnketaUserPitanje",s.Int,null),l(t,u,a,o,"PkAnketaUserPitanje").pipe(D(),j(({PkAnketaUserPitanje:e})=>i?Array.isArray(n)?b(n.map(a=>k({PkAnketaUserPitanje:e,Odgovor:a}))).pipe(D()):k({PkAnketaUserPitanje:e,Odgovor:n}).pipe(D()):I(null)))}return I(!0)};(()=>{const{request:e,conn:t}=c("Ankete.[spStatistikaAnketaCounter_upsert]",a.locals.currDatabase,a,o);return e.addParameter("PkAnketa",s.Int,n),e.addParameter("PkPredlozak",s.Int,P),e.addOutputParameter("PkStatistikaAnketa",s.Int,null),l(e,t,a,o,"PkStatistikaAnketa")})().pipe(D()).subscribe(e=>{});const{AnketaAnonimnaDaNe:C}=m;return t&&t.PkUsera?(({PkAnketa:e,PkUser:t})=>{const{request:r,conn:n}=c("Ankete.spAnketaUser_select",a.locals.currDatabase,a,o);return r.addParameter("PkAnketa",s.Int,e),r.addParameter("PkUser",s.Int,t),d(r,n,a,o)})({PkAnketa:n,PkUser:t.PkUsera}).pipe(D()).subscribe({next:([e])=>((({PkAnketa:e,PkUser:t})=>{const{request:r,conn:n}=c("Ankete.spAnketaUserSolved_update",a.locals.currDatabase,a,o);return r.addParameter("PkAnketa",s.Int,e),r.addParameter("PkUser",s.Int,t),d(r,n,a,o)})({PkAnketa:n,PkUser:e.PkUser}).pipe(D()).subscribe(e=>{}),b(r.map(a=>f({PkAnketaUser:e.PkAnketaUser,pitanje:a}))).pipe(D()).subscribe({next:e=>{a.status(200).send({complete:e})},error:e=>{a.status(500).send({message:e.message})}})),error:e=>{a.status(500).send({message:e.message})}}):C?b(r.map(e=>f({PkAnketaUser:null,pitanje:e}))).pipe(D()).subscribe({next:e=>{a.status(200).send({complete:e})},error:e=>{a.status(500).send({message:e.message})}}):void a.status(200).send({message:"STD:ILLEGAL_STATE"})}),r.put("/predlozak/templating/question/reorder",async function(e,a){if(!await g({modul:"Ankete",claim:"Predlozak"},e))return a.status(401).send({message:"STD:UNATHORIZED_ACCES"});const t=await i(e,a),{swap:r,current:u,target:d,PkPredlozak:l}=e.body,{PkPitanjeFrom:P,PkPitanjeTo:m}=r,{request:k,conn:p}=c("Ankete.spPitanjeRedoslijed_Update",a.locals.currDatabase,a,o);k.addParameter("PkPitanjeFrom",s.Int,P),k.addParameter("PkPitanjeTo",s.Int,m),k.addParameter("RedoslijedFrom",s.Int,u),k.addParameter("RedoslijedTo",s.Int,d),k.addParameter("PkPredlozak",s.Int,l),k.addParameter("UserPromjene",s.NVarChar,t.ImePrezimeUsera),k.addParameter("PkUserPromjene",s.Int,t.PkUsera),o.execStoredProcFromNode(k,p,a,(e,t,r)=>{n(e,t,r,a)})}),r.put("/predlozak/templating/question/replace",async function(e,a){if(!await g({modul:"Ankete",claim:"Predlozak"},e))return a.status(401).send({message:"STD:UNATHORIZED_ACCES"});const t=await i(e,a),{pitanje:r,odgovori:n,PkPredlozak:u}=e.body,P=()=>b([(()=>{const{request:e,conn:n}=c("Ankete.spPitanje_Update",a.locals.currDatabase,a,o),{PkPitanje:i,PitanjeTekst:u,PkPitanjeTip:l,PitanjeAktivnoDaNe:P,PitanjeObaveznoDaNe:m}=r;return e.addParameter("PkPitanje",s.Int,i),e.addParameter("PitanjeTekst",s.NVarChar,u),e.addParameter("PkPitanjeTip",s.Int,l),e.addParameter("PitanjeAktivnoDaNe",s.Int,P),e.addParameter("PitanjeObaveznoDaNe",s.Int,m),e.addParameter("PkUser",s.Int,t.PkUsera),e.addParameter("User",s.NVarChar,t.ImePrezimeUsera),d(e,n,a,o)})(),...r.odgovori?r.odgovori.map(e=>(e=>{const{request:t,conn:r}=c("Ankete.spOdgovor_delete",a.locals.currDatabase,a,o);return t.addParameter("PkOdgovor",s.Int,e),d(t,r,a,o)})(e.PkOdgovor)):[],...n&&n.length?n.map((e,n)=>((e,n)=>{const{request:i,conn:u}=c("Ankete.spOdgovor_upsert",a.locals.currDatabase,a,o),{PkPitanje:l}=r,{OdgovorTekst:P}=e;return i.addParameter("PkPitanje",s.Int,l),i.addParameter("OdgovorTekst",s.NVarChar,P),i.addParameter("OdgovorRedoslijed",s.NVarChar,`${n}`),i.addParameter("PkUserUnos",s.Int,t.PkUsera),i.addParameter("PkUserPromjena",s.Int,t.PkUsera),i.addParameter("PkUsera",s.Int,t.PkUsera),i.addParameter("User",s.NVarChar,t.ImePrezimeUsera),i.addOutputParameter("PkOdgovor",s.Int,null),d(i,u,a,o)})(e,n+1)):[]]).pipe(D()).subscribe(e=>{a.send({message:"OK"})});if(r.PkPitanje)return P();(()=>{const{request:e,conn:n}=c("Ankete.spPitanje_Insert",a.locals.currDatabase,a,o),{PitanjeTekst:i,PkPitanjeTip:u,PitanjeAktivnoDaNe:d,PitanjeObaveznoDaNe:P}=r;return e.addParameter("PitanjeTekst",s.NVarChar,i),e.addParameter("PkPitanjeTip",s.Int,u),e.addParameter("PitanjeAktivnoDaNe",s.Int,d),e.addParameter("PitanjeObaveznoDaNe",s.Int,P),e.addParameter("PkUser",s.Int,t.PkUsera),e.addParameter("User",s.NVarChar,t.ImePrezimeUsera),e.addOutputParameter("PkPitanje",s.Int,null),l(e,n,a,o,"PkPitanje")})().pipe(D(),j(({PkPitanje:e})=>(r.PkPitanje=e,O({PkPitanje:e,PkPredlozak:u,db:o,pitanje:r,res:a,user:t})))).subscribe(({PkPredlozakPitanje:e})=>{P()})}),r.put("/predlozak/proglasiAnketom",async function(e,a){if(!await g({modul:"Ankete",claim:"Predlozak"},e))return a.status(401).send({message:"STD:UNATHORIZED_ACCES"});const t=await i(e,a),{PkPredlozak:r,AnketaAnonimnaDaNe:n,AnketaOtvorenaDo:u,AnketaOtvorenaOd:P,Clanstva:k,AnketaNaziv:p}=e.body;(()=>{const{request:e,conn:i}=c("Ankete.spPredlozakProglasiAnketom",a.locals.currDatabase,a,o);e.addParameter("PkPredlozak",s.Int,r),e.addParameter("PkUser",s.Int,t.PkUsera),e.addParameter("User",s.NVarChar,t.ImePrezimeUsera),e.addParameter("AnketaNaziv",s.NVarChar,p),e.addParameter("AnketaAnonimnaDaNe",s.Int,n),e.addParameter("AnketaOtvorenaDo",s.Date,u),e.addParameter("AnketaOtvorenaOd",s.Date,P);const d=k?k.join(","):null;return d&&e.addParameter("VidljivaPkVrstiClanovimaArray",s.NVarChar,d),e.addOutputParameter("PkAnketa",s.Int,null),l(e,i,a,o,"PkAnketa")})().pipe(D()).subscribe(({PkAnketa:e})=>b(k.map(t=>(({PkAnketa:e,PkVrstaClanstva:t})=>{const{request:r,conn:n}=c("Ankete.spUsersForAnketaSend",a.locals.currDatabase,a,o);return r.addParameter("PkAnketa",s.Int,e),r.addParameter("PkClanstvo",s.Int,t),d(r,n,a,o)})({PkAnketa:e,PkVrstaClanstva:t}))).pipe(D()).subscribe(r=>{if(r){const n=t=>f(N({user:t,lang:a.locals.language,PkAnketa:e})),i=m(r);b(m([...i.map(r=>[n(r),(({PkAnketa:e,PkUser:r})=>{const{request:n,conn:i}=c("Ankete.spUserMapToAnketa",a.locals.currDatabase,a,o);return n.addParameter("PkAnketa",s.Int,e),n.addParameter("PkUser",s.Int,y(r)),n.addParameter("PkUserPromjena",s.Int,t.PkUsera),n.addParameter("UserPromjena",s.NVarChar,t.ImePrezimeUsera),d(n,i,a,o)})({PkAnketa:e,PkUser:r.PkUsera})])])).pipe(D()).subscribe({next:e=>{a.send(e)},error:e=>{a.status(500).send(e)}})}}))}),r.put("/anketa/manage",async function(e,a){if(!await g({modul:"Ankete",claim:"Anketa"},e))return a.status(401).send({message:"STD:UNATHORIZED_ACCES"});const t=await i(e,a),{PkAnketa:r,IsActive:n,AnketaOtvorenaOd:u,AnketaOtvorenaDo:l}=e.body;(()=>{const{request:e,conn:i}=c("Ankete.spAnketa_Update",a.locals.currDatabase,a,o);return e.addParameter("PkAnketa",s.Int,r),e.addParameter("IsActive",s.Int,n),e.addParameter("AnketaOtvorenaOd",s.DateTime,u),e.addParameter("AnketaOtvorenaDo",s.DateTime,l),e.addParameter("PkUser",s.Int,t.PkUsera),e.addParameter("User",s.NVarChar,t.ImePrezimeUsera),d(e,i,a,o)})().pipe(D()).subscribe(e=>{a.send({message:"OK"})})}),r.delete("/predlozak/templating/question/delete",async function(e,a){if(!await g({modul:"Ankete",claim:"Predlozak"},e))return a.status(401).send({message:"STD:UNATHORIZED_ACCES"});const{PkPitanje:t,PkPredlozak:r}=e.query,{request:i,conn:u}=c("Ankete.spPitanje_Delete",a.locals.currDatabase,a,o);i.addParameter("PkPitanje",s.Int,t),i.addParameter("PkPredlozak",s.Int,r),o.execStoredProcFromNode(i,u,a,(e,t,r)=>n(e,t,r,a))}),r.delete("/predlozak/delete",async function(e,a){if(!await g({modul:"Ankete",claim:"Predlozak"},e))return a.status(401).send({message:"STD:UNATHORIZED_ACCES"});const{PkPredlozak:t}=e.query,{request:r,conn:i}=c("Ankete.spPredlozak_delete",a.locals.currDatabase,a,o);r.addParameter("PkPredlozak",s.Int,t),o.execStoredProcFromNode(r,i,a,(e,t,r)=>n(e,t,r,a))}),r.delete("/anketa/delete",async(e,a,t)=>{if(!await g({modul:"Ankete",claim:"Anketa"},e))return a.status(401).send({message:"STD:UNATHORIZED_ACCES"});const{PkAnketa:r}=e.query;(()=>{const{request:e,conn:t}=c("[Ankete].[spAnketa_delete]",a.locals.currDatabase,a,o);return e.addParameter("PkAnketa",s.Int,r),d(e,t,a,o)})().pipe(D()).subscribe({next:e=>{a.send({message:"OK"})},error:e=>{a.status(500).send(e)}})}),e.exports={anketeRouter:r}},"./src/api/forum.js":function(e,a,t){const r=t("express").Router(),{TYPES:s}=t("tedious"),o=t("./src/db.js"),{simpleDbResolve:n,handleRequestUser:i,constructDirDepth:u,decryptIfEncrypted:c,exists:d,groupFlatProperies:l,groupDataByKeySync:P,hasClaim:m}=t("./src/services/app.service.js"),k=t("formidable"),p=t("fs-extra"),g=t("./src/kripto.js"),{uuid:b}=t("uuidv4"),{createDatotekaInsertRequest:f,createDatotekaRelacijaRequest:D}=t("./src/services/profile.service.js");function j({request:e,conn:a,res:t}){return new Promise(r=>{o.execStoredProcFromNode(e,a,t,(e,a,t)=>{r("OK"==e?t:{message:e})})})}r.get("/kategorije",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spKategorija_Select",t,a);r.addParameter("PkKategorija",s.Int,e.query.PkKategorija),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/potkategorije",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spPotKategorija_Select",t,a);r.addParameter("PkKategorija",s.Int,e.query.PkKategorija),e.query.skip&&r.addParameter("skip",s.Int,e.query.skip),e.query.take&&r.addParameter("take",s.Int,e.query.take),e.query.query&&r.addParameter("query",s.NVarChar,e.query.query),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/komentari",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spKomentar_Select",t,a);r.addParameter("PkObjava",s.Int,e.query.PkObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>{if("OK"==e){r=r.map(e=>{const{groupId:a,PkObjavaOccurence:t}=e;return Object.keys(e).forEach(r=>{if(r.includes(a)){const[s,o]=r.split(a),n=`${s}.${t-1}.${o}`;delete Object.assign(e,{[n]:e[r]})[r]}}),e});const e=P(r,"PkKomentar");return r=(r=Object.keys(e).map(a=>({...e[a].reduce((e,a)=>({...e,...a}),{})}))).map(e=>l(e)),a.status(200).send(r)}return a.status(500).send({message:"STD:INVALID_REQUEST"})})}),r.get("/komentar",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spKomentar_Select",t,a);r.addParameter("PkKomentar",s.Int,e.query.PkKomentar),r.addParameter("PkObjava",s.Int,e.query.PkObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>{if("OK"==e){r=r.map(e=>{const{groupId:a,PkObjavaOccurence:t}=e;return Object.keys(e).forEach(r=>{if(r.includes(a)){const[s,o]=r.split(a),n=`${s}.${t-1}.${o}`;delete Object.assign(e,{[n]:e[r]})[r]}}),e});const e=P(r,"PkKomentar");return r=(r=Object.keys(e).map(a=>({...e[a].reduce((e,a)=>({...e,...a}),{})}))).map(e=>l(e)),a.status(200).send(r)}return a.status(500).send({message:"STD:INVALID_REQUEST"})})}),r.get("/objave",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spObjava_Select",t,a);e.query.PkObjava&&r.addParameter("PkObjava",s.Int,e.query.PkObjava),e.query.PkKategorija&&r.addParameter("PkKategorija",s.Int,e.query.PkKategorija),e.query.skip&&r.addParameter("skip",s.Int,e.query.skip),e.query.take&&r.addParameter("take",s.Int,e.query.take),e.query.query&&r.addParameter("query",s.NVarChar,e.query.query),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/objavaPrilozi",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spObjavaPrilozi_select",t,a);e.query.PkObjava&&r.addParameter("PkForumObjava",s.Int,e.query.PkObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>"OK"==e?a.status(200).send(r.map(e=>l(e))):a.status(500).send({message:"STD:INVALID_REQUEST"}))}),r.post("/kategorija",async function(e,a){if(await m({modul:"Forum",claim:"Kategorija"},e)){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Forum.spKategorija_Insert",r,a);u.addParameter("Naziv",s.NVarChar,e.body.Naziv),u.addParameter("Opis",s.NVarChar,e.body.Opis),u.addParameter("UserUnos",s.NVarChar,t.ImePrezimeUsera),u.addParameter("PkUserUnos",s.Int,t.PkUsera),u.addParameter("ParentPk",s.Int,e.body.ParentPk),e.body.PublicDaNe&&u.addParameter("PublicDaNe",s.Int,e.body.PublicDaNe),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.post("/komentar",async function(e,a){if(await m({modul:"Forum",claim:"Komentar"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spKomentar_Insert",t,a);r.addParameter("Sadrzaj",s.NVarChar,e.body.Sadrzaj),r.addParameter("PkUseraUnos",s.Int,e.body.PkUseraUnos),r.addParameter("PkObjava",s.Int,e.body.PkObjava),r.addParameter("ParentPk",s.Int,e.body.ParentPk),r.addParameter("Dubina",s.Int,e.body.Dubina),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.post("/objava",async function(e,a){if(await m({modul:"Forum",claim:"Objava"},e)){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Forum.spObjava_Insert",r,a);u.addParameter("Naslov",s.NVarChar,e.body.Naslov),u.addParameter("Sadrzaj",s.NVarChar,e.body.Sadrzaj),u.addParameter("PkUseraUnos",s.Int,t.PkUsera),u.addParameter("PkKategorija",s.Int,e.body.PkKategorija),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.post("/attachment",async function(e,a){if(await m({modul:"Forum",claim:"Objava"},e)){const t=await i(e,a),r=new k.IncomingForm,s=u(["uploads","tempFiles","korisnici","attachment"]);r.uploadDir=s,r.keepExtensions=!0;try{r.parse(e,async function(e,r,{CoverImage:i,file:l}){const{Naziv:P,Opis:m,PkObjava:k,PkOsobniPodaciPkUsera:g}=r,j=b(),C=u(["uploads","korisnici",g,"attachments","forum",`${k}`,`${j}/`]),E=`korisnici/${g}/attachments/forum/${k}/${j}/`,v=i?`korisnici/${g}/attachments/forum/${k}/${j}/${j}_${i.name}`:null,A=`korisnici/${g}/attachments/forum/${k}/${j}/${j}_${l.name}`;i&&p.renameSync(i.path,`${C}${j}_${i.name}`),p.renameSync(l.path,`${C}${j}_${l.name}`),p.removeSync(s);const I=({dbPath:e,dbSavePathRoot:t,user:r,filename:s,file:n,Naziv:i,Opis:u,PkOsobniPodaciPkUsera:c})=>new Promise(c=>{const{size:d,path:l,name:P,type:m,hash:k,lastModifiedDate:p}=n,{conn:g,request:b}=f({Naziv:i,Opis:u,PkDatoteka:null,PkUseraPromjena:r.PkUsera,PkUseraUnos:r.PkUsera,UserPromjena:r.ImePrezimeUsera,UserUnos:r.ImePrezimeUsera,destination:t,encoding:null,filename:s,mimetype:m,originalname:P,path:e,size:d},a);o.execStoredProcFromNode(b,g,a,(e,a,t)=>{if("OK"==e){const{PkDatoteka:e}=a;c({PkDatoteka:e})}else c({PkDatoteka:null})})});let N=null;if(i){const{PkDatoteka:e}=await I({Naziv:P,Opis:m,PkOsobniPodaciPkUsera:g,dbPath:v,filename:`${j}_${i.name}`,dbSavePathRoot:E,user:t,file:i});N=d(e)?e:null}const{PkDatoteka:y}=await I({Naziv:P,Opis:m,PkOsobniPodaciPkUsera:g,dbPath:A,filename:`${j}_${l.name}`,dbSavePathRoot:E,user:t,file:l}),{conn:S,request:U}=D({PkForumObjava:k,PkDatoteka:y,PkDatotekaCoverImage:N,PkUsera:c(g),PkForumObjavaKomentar:null},a);o.execStoredProcFromNode(U,S,a,(e,t,r)=>n(e,t,r,a))})}catch(e){a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.post("/attachment/comment",async function(e,a){if(await m({modul:"Forum",claim:"Komentar"},e)){const t=await i(e,a),r=new k.IncomingForm,n=u(["uploads","tempFiles","korisnici","attachment"]);r.uploadDir=n,r.keepExtensions=!0,r.multiples=!0;try{r.parse(e,async function(e,r,i){r=l(r);const{prilogDummyPk:P}=r;i=l(i);const{PkObjava:m,Sadrzaj:k,UserUnos:C,ParentPk:E,Dubina:v}=r;let{PkUsera:A}=t,I=d(E)?E:null,N=d(v)?v:null;const{PkKomentar:y}=await async function({Sadrzaj:e,PkUseraUnos:a,PkObjava:t,ParentPk:r=null,Dubina:n=null},i){return new Promise((u,c)=>{const d=o.createConnection(i.locals.currDatabase),l=o.createRequest("Forum.spKomentar_Insert",d,i);l.addParameter("Sadrzaj",s.NVarChar,e),l.addParameter("PkUseraUnos",s.Int,a),l.addParameter("PkObjava",s.Int,t),l.addParameter("ParentPk",s.Int,r),l.addParameter("Dubina",s.Int,n),l.addOutputParameter("PkKomentar",s.Int,null),o.execStoredProcFromNode(l,d,i,(e,a,t)=>{if("OK"==e){const{PkKomentar:e}=a;u({PkKomentar:e})}else u({PkDatoteka:null})})})}({Sadrzaj:k,PkObjava:m,PkUseraUnos:A,Dubina:N,ParentPk:I},a);if(P){A=g.encryptString(""+A);const e=P.map(e=>({file:i.file[+e],...i.CoverImage&&{CoverImage:i.CoverImage[+e]},Naziv:r.NazivDatotekaMeta[+e],Opis:r.OpisDatotekaMeta[+e]})).filter(e=>e);for(const{file:r,CoverImage:s,Naziv:n,Opis:i}of e){const e=b(),l=u(["uploads","korisnici",`${A}`,"attachments","forum",`${m}`,"comment",`${e}/`]),P=`korisnici/${A}/attachments/forum/${m}/comment/${e}/`,k=s?`korisnici/${A}/attachments/forum/${m}/comment/${e}/${e}_${s.name}`:null,g=`korisnici/${A}/attachments/forum/${m}/comment/${e}/${e}_${r.name}`;s&&p.renameSync(s.path,`${l}${e}_${s.name}`),p.renameSync(r.path,`${l}${e}_${r.name}`);const C=({dbPath:e,dbSavePathRoot:t,user:r,filename:s,file:n,Naziv:i,Opis:u,PkOsobniPodaciPkUsera:c})=>new Promise(c=>{const{size:d,path:l,name:P,type:m,hash:k,lastModifiedDate:p}=n,{conn:g,request:b}=f({Naziv:i,Opis:u,PkDatoteka:null,PkUseraPromjena:r.PkUsera,PkUseraUnos:r.PkUsera,UserPromjena:r.ImePrezimeUsera,UserUnos:r.ImePrezimeUsera,destination:t,encoding:null,filename:s,mimetype:m,originalname:P,path:e,size:d},a);o.execStoredProcFromNode(b,g,a,(e,a,t)=>{if("OK"==e){const{PkDatoteka:e}=a;c({PkDatoteka:e})}else c({PkDatoteka:null})})});let E=null;if(s){const{PkDatoteka:a}=await C({Naziv:n,Opis:i,PkOsobniPodaciPkUsera:A,dbPath:k,filename:`${e}_${s.name}`,dbSavePathRoot:P,user:t,file:s});E=d(a)?a:null}const{PkDatoteka:v}=await C({Naziv:n,Opis:i,PkOsobniPodaciPkUsera:A,dbPath:g,filename:`${e}_${r.name}`,dbSavePathRoot:P,user:t,file:r}),{conn:I,request:N}=D({PkForumObjava:m,PkDatoteka:v,PkDatotekaCoverImage:E,PkUsera:c(A),PkForumObjavaKomentar:y},a);await j({request:N,conn:I,res:a})}}p.removeSync(n),a.status(200).send({PkKomentar:y})})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.put("/kategorija",async function(e,a){if(await m({modul:"Forum",claim:"Kategorija"},e)){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Forum.spKategorija_Update",r,a);u.addParameter("PkKategorija",s.Int,e.body.PkKategorija),u.addParameter("Naziv",s.NVarChar,e.body.Naziv),u.addParameter("Opis",s.NVarChar,e.body.Opis),u.addParameter("UserPromjenio",s.NVarChar,t.ImePrezimeUsera),u.addParameter("PkUseraPromjenio",s.Int,t.PkUsera),u.addParameter("RowVersion",s.NVarChar,e.body.RowVersion),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.put("/komentar",async function(e,a){if(await m({modul:"Forum",claim:"Komentar"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spKomentar_Update",t,a);r.addParameter("Sadrzaj",s.NVarChar,e.body.Sadrzaj),r.addParameter("PkKomentar",s.Int,e.body.PkKomentar),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.put("/objava",async function(e,a){if(await m({modul:"Forum",claim:"Objava"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spObjava_Update",t,a);r.addParameter("Naslov",s.NVarChar,e.body.Naslov),r.addParameter("Sadrzaj",s.NVarChar,e.body.Sadrzaj),r.addParameter("PkObjava",s.Int,e.body.PkObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.delete("/kategorija",async function(e,a){if(await m({modul:"Forum",claim:"Kategorija"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spKategorija_Delete",t,a);r.addParameter("PkKategorija",s.Int,e.query.PkKategorija),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.delete("/komentar",async function(e,a){if(await m({modul:"Forum",claim:"Komentar"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spKomentar_Delete",t,a);r.addParameter("PkKomentar",s.Int,e.query.PkKomentar),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.delete("/objava",async function(e,a){if(await m({modul:"Forum",claim:"Objava"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Forum.spObjava_Delete",t,a);r.addParameter("PkObjava",s.Int,e.query.PkObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),e.exports={forumRouter:r}},"./src/api/obavijesti.js":function(e,a,t){const r=t("express").Router(),{TYPES:s}=t("tedious"),o=t("./src/db.js"),{simpleDbResolve:n,flatten:i,constructDirDepth:u,handleRequestUser:c,exists:d,decryptIfEncrypted:l,constructConnection:P,hasClaim:m,makeObservableConnection:k}=t("./src/services/app.service.js"),p=t("formidable"),g=t("path"),b=t("fs-extra"),{uuid:f}=t("uuidv4"),{sendObavijestLinkMail:D}=t("./src/mail/mail.js"),{forkJoin:j,from:C,first:E}=t("rxjs"),{send:v}=t("process");t("./src/kripto.js");r.get("/obavijest",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("[Alumni].spObavijest_Select",t,a);r.addParameter("PkObavijest",s.Int,e.query.PkObavijest),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/obavijestCategoryGroup",async function(e,a,t){const r=await c(e,a);try{const i=o.createConnection(a.locals.currDatabase),u=o.createRequest("Alumni.[spObavijestKategorijaJoined_Select]",i,a);u.addParameter("skip",s.Int,e.query.skip),u.addParameter("take",s.Int,e.query.take),u.addParameter("PkViewUsera",s.Int,l(r.PkUsera)),u.addParameter("PkVrstaClanstva",s.Int,d(r.PkVrstaClanstva)?r.PkVrstaClanstva:4),o.execStoredProcFromNode(u,i,a,(e,t,r)=>{n(e,t,r,a)})}catch(e){t(e)}}),r.get("/obavijestForCategoryFTS",async function(e,a,t){const r=await c(e,a);try{const i=o.createConnection(a.locals.currDatabase),u=o.createRequest("Alumni.[spObavijest_FTSSelect]",i,a);u.addParameter("skip",s.Int,e.query.skip),u.addParameter("take",s.Int,e.query.take),u.addParameter("Search",s.NVarChar,e.query.search),u.addParameter("PkObavijestKategorija",s.NVarChar,e.query.PkObavijestKategorija),u.addParameter("PkUsera",s.Int,d(e.query.PkUsera)?e.query.PkUsera:null),u.addParameter("PkViewUsera",s.Int,l(r.PkUsera)),e.query.PkUsera||u.addParameter("PkVrstaClanstva",s.Int,d(r.PkVrstaClanstva)?r.PkVrstaClanstva:4),o.execStoredProcFromNode(u,i,a,(e,t,r)=>{n(e,t,r,a)})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace("obavijestForCategoryFTS",e),t(e)}}),r.put("/obavijestStatus",async function(e,a,t){const r=await c(e,a);try{const i=o.createConnection(a.locals.currDatabase),u=o.createRequest("Alumni.[spObavijestStatus_Update]",i,a);u.addParameter("UserZadnjePromjene",s.NVarChar,r.ImePrezimeUsera),u.addParameter("Status",s.Int,e.body.Status),u.addParameter("PkObavijest",s.Int,e.body.PkObavijest),o.execStoredProcFromNode(u,i,a,(e,t,r)=>{n(e,t,r,a)})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace("obavijestStatus",e),t(e)}}),r.post("/obavijest",async function(e,a){if(await m({modul:"Obavijesti",claim:"Dodavanje"},e)){const t=await c(e,a),r=o.createConnection(a.locals.currDatabase),n=o.createRequest("[Alumni].spObavijest_Insert",r,a);n.addParameter("Naslov",s.NVarChar,e.body.Naslov),n.addParameter("CoverImagePath",s.NVarChar,e.body.CoverImagePath),n.addParameter("Html",s.NVarChar,e.body.Html),n.addParameter("DatumObjave",s.Date,e.body.DatumObjave),e.body.DatumIskljucenjaObavijest&&n.addParameter("DatumIskljucenjaObavijest",s.Date,e.body.DatumIskljucenjaObavijest),n.addParameter("UserUnos",s.NVarChar,e.body.UserUnos?e.body.UserUnos:t.ImePrezimeUsera),n.addParameter("UserZadnjePromjene",s.NVarChar,e.body.UserZadnjePromjene?e.body.UserZadnjePromjene:t.ImePrezimeUsera),n.addParameter("Status",s.Int,e.body.Status),n.addParameter("Tags",s.NVarChar,e.body.Tags),n.addParameter("PkUsera",s.Int,e.body.PkUsera?e.body.PkUsera:t.PkUsera),n.addParameter("PkObavijestKategorija",s.Int,e.body.PkObavijestKategorija),n.addOutputParameter("PkObavijest",s.Int,null),o.execStoredProcFromNode(n,r,a,(e,t,r)=>{if("OK"==e){const{PkObavijest:e}=t;a.status(200).send({PkObavijest:e})}else a.status(500).send({message:"STD:INVALID_REQUEST"})})}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.put("/obavijest",async function(e,a){if(await m({modul:"Obavijesti",claim:"Dodavanje"},e)){const t=await c(e,a),r=o.createConnection(a.locals.currDatabase),i=o.createRequest("[Alumni].spObavijest_Update",r,a);i.addParameter("PkObavijest",s.Int,e.body.PkObavijest),i.addParameter("Naslov",s.NVarChar,e.body.Naslov),i.addParameter("CoverImagePath",s.NVarChar,e.body.CoverImagePath),i.addParameter("Html",s.NVarChar,e.body.Html),i.addParameter("DatumObjave",s.Date,e.body.DatumObjave),e.body.DatumIskljucenjaObavijest&&i.addParameter("DatumIskljucenjaObavijest",s.Date,e.body.DatumIskljucenjaObavijest),i.addParameter("DatumUnosa",s.DateTime,e.body.DatumUnosa),i.addParameter("UserUnos",s.NVarChar,e.body.UserUnos),i.addParameter("Tags",s.NVarChar,e.body.Tags),i.addParameter("UserZadnjePromjene",s.NVarChar,t.ImePrezimeUsera),i.addParameter("Status",s.Int,e.body.Status),i.addParameter("PkObavijestKategorija",s.Int,e.body.PkObavijestKategorija),i.addParameter("PkUsera",s.Int,e.body.PkUsera),o.execStoredProcFromNode(i,r,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.delete("/obavijest",async function(e,a){if(await m({modul:"Obavijesti",claim:"Dodavanje"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("[Alumni].spObavijest_Delete",t,a);try{const i=u(["public","obavijesti",e.query.PkObavijest+"/"]),c=b.readdirSync(i);for(const e of c)b.unlinkSync(g.join(i,e));b.rmdirSync(i),r.addParameter("PkObavijest",s.Int,e.query.PkObavijest),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}catch(e){a.status(500).send({message:"STD:INVALID_REQUEST"})}}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.get("/obavijestiKategorija",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("[Alumni].spObavijestKategorija_Select",t,a);r.addParameter("PkObavijestKategorija",s.Int,e.query.PkObavijestKategorija),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/obavijestiKategorijaAll",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("[Alumni].spObavijestKategorijaAll_Select",t,a);o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/obavijestForCategory",async function(e,a){const t=await c(e,a);if(!e.query.PkObavijestKategorija)return a.status(200).send([]);{const r=o.createConnection(a.locals.currDatabase),i=o.createRequest("[Alumni].obavijestForCategory_Select",r,a);i.addParameter("skip",s.Int,e.query.skip),i.addParameter("take",s.Int,e.query.take),i.addParameter("PkObavijestKategorija",s.Int,e.query.PkObavijestKategorija),i.addParameter("PkUsera",s.Int,d(e.query.PkUsera)?e.query.PkUsera:null),i.addParameter("PkViewUsera",s.Int,l(t.PkUsera)),e.query.PkUsera||i.addParameter("PkVrstaClanstva",s.Int,d(t.PkVrstaClanstva)?t.PkVrstaClanstva:4),o.execStoredProcFromNode(i,r,a,(e,t,r)=>n(e,t,r,a))}}),r.post("/obavijestiKategorija",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("[Alumni].spObavijestKategorija_Insert",t,a);r.addParameter("NazivKategorije",s.NVarChar,e.body.NazivKategorije),r.addParameter("UserUnos",s.NVarChar,e.body.UserUnos),r.addParameter("DatumUnosa",s.DateTime,e.body.DatumUnosa),r.addParameter("AktivnaDaNe",s.Int,e.body.AktivnaDaNe),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.put("/obavijestiKategorija",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("[Alumni].spObavijestKategorija_Update",t,a);r.addParameter("NazivKategorije",s.NVarChar,e.body.NazivKategorije),r.addParameter("UserUnos",s.NVarChar,e.body.UserUnos),r.addParameter("DatumUnosa",s.DateTime,e.body.DatumUnosa),r.addParameter("AktivnaDaNe",s.Int,e.body.AktivnaDaNe),r.addParameter("PkObavijestKategorija",s.Int,e.body.PkObavijestKategorija),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.delete("/obavijestiKategorija",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("[Alumni].spObavijestKategorija_Delete",t,a);r.addParameter("PkObavijestKategorija",s.Int,e.query.PkObavijestKategorija),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.post("/uploadCoverImage",async function(e,a){const t=await c(e,a),r=new p.IncomingForm,i=u(["uploads","tempFiles","obavijesti"]);r.uploadDir=i,r.keepExtensions=!0;try{r.parse(e,function(e,r,{file:i}){try{const e=u(["public","obavijesti",r.PkObavijest+"/"]),c=f(),d=b.readdirSync(e);for(const a of d)b.unlinkSync(g.join(e,a));const l=`obavijesti/${r.PkObavijest}/${c}_${i.name}`;b.renameSync(i.path,`${e}${c}_${i.name}`);const P=o.createConnection(a.locals.currDatabase),m=o.createRequest("[Alumni].spObavijestImage_Update",P,a);m.addParameter("PkObavijest",s.Int,r.PkObavijest),m.addParameter("CoverImagePath",s.NVarChar,l),m.addParameter("UserZadnjePromjene",s.NVarChar,t.ImePrezimeUsera),o.execStoredProcFromNode(m,P,a,(e,t,r)=>n(e,t,r,a))}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}}),r.post("/vidljivostObavijestiVrstaClanstva",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Alumni.spVidljivostObavijestiVrstaClanstva_Insert",t,a);r.addParameter("PkObavijest",s.Int,e.body.PkObavijest),r.addParameter("PkVrstaClanstva",s.Int,e.body.PkVrstaClanstva),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.post("/sendObavijestLinkMail",function(e,a){const{PkObavijest:t,Clanstva:r}=e.body;j(r.map(e=>(({PkVrstaClanstva:e})=>{const{request:t,conn:r}=P("Alumni.spUsersForObavijestSend",a.locals.currDatabase,a,o);return t.addParameter("PkClanstvo",s.Int,e),k(t,r,a,o)})({PkVrstaClanstva:e}))).pipe(E()).subscribe(e=>{if(e){const r=e=>C(D({user:e,lang:a.locals.language,PkObavijest:t})),s=i(e);j(s.map(e=>r(e))).pipe(E()).subscribe({next:e=>{a.send(e)},error:e=>{global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send(e)}})}else a.send()})}),e.exports=r},"./src/api/pretplate.js":function(e,a,t){const r=t("express").Router(),{TYPES:s}=t("tedious"),o=t("./src/db.js"),{simpleDbResolve:n,handleRequestUser:i}=t("./src/services/app.service.js");r.get("/check",async function(e,a){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Alumni.spCheckUserPretplata",r,a);u.addParameter("Modul",s.NVarChar,e.query.modul),u.addParameter("Segment",s.NVarChar,e.query.segment),u.addParameter("PkUsera",s.Int,t.PkUsera),u.addParameter("Pk",s.Int,e.query.pk),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}),r.get("",async function(e,a){const t=await i(e,a);if(!t)return a.status(500).json({success:!1,error:"There is no logged in user!"});const r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Alumni.spPretplate_Select",r,a);u.addParameter("PkUsera",s.Int,t.PkUsera),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}),r.post("",async function(e,a){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Alumni.spPretplate_Insert",r,a);u.addParameter("Modul",s.NVarChar,e.body.modul),u.addParameter("Segment",s.NVarChar,e.body.segment),u.addParameter("PkUsera",s.Int,t.PkUsera),u.addParameter("Pk",s.Int,e.body.pk),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}),r.delete("",async function(e,a){await i(e,a);const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Alumni.spPretplate_Delete",t,a);r.addParameter("PkPretplate",s.Int,e.query.PkPretplate),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/pretplataData",async function(e,a){if(!await i(e,a))return a.status(500).send({success:!1,message:"There is no logged in user!"});const t=o.createConnection(a.locals.currDatabase);let r=null;switch((e.query.Modul+"_"+e.query.Segment).toUpperCase()){case"FORUM_KATEGORIJA":(r=o.createRequest("Alumni.spPretplateForumKategorija_Select",t,a)).addParameter("PkKategorija",s.Int,e.query.Pk),r.addParameter("DatumZadnjeProvjere",s.NVarChar,e.query.DatumZadnjeProvjere);break;case"E-BIBLIOTEKA_KATEGORIJA":(r=o.createRequest("Alumni.spPretplateResursiKategorija_Select",t,a)).addParameter("PkResursKategorija",s.Int,e.query.Pk),r.addParameter("DatumZadnjeProvjere",s.NVarChar,e.query.DatumZadnjeProvjere);break;default:a.status(400).send({success:!1,message:"Bad request!"})}o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.put("/datumZadnjeProvjere",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Alumni.spPretplate_UpdateDatumZadnjeProvjere",t,a);r.addParameter("PkPretplate",s.Int,e.body.PkPretplate),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),e.exports={pretplateRouter:r}},"./src/api/profile.js":function(e,a,t){const r=t("express").Router(),{TYPES:s}=t("tedious"),o=t("./src/db.js"),{simpleDbResolve:n,handleRequestUser:i,exists:u,groupDataByKeySync:c,constructDirDepth:d,decryptIfEncrypted:l,groupFlatProperies:P,devLogger:m}=t("./src/services/app.service.js"),k=t("formidable"),p=t("path"),g=t("fs-extra"),{uuid:b}=t("uuidv4"),f=t("./src/kripto.js"),{createUpsertOsobniPodaciRequest:D,createDatotekaInsertRequest:j,createDatotekaRelacijaRequest:C,fetchDatotekaInfo:E,deletePrilog:v}=t("./src/services/profile.service.js"),{checkFileExists:A,removeDiacritics:I}=t("./src/tools.js");r.get("/profile",function(e,a){if(!e.query||!e.query.PkUsera)return a.status(500).send({message:null});const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Alumni.[spOsobniPodaciSvi]",t,a);r.addParameter("PkUsera",s.Int,e.query.PkUsera),o.execStoredProcFromNode(r,t,a,(e,t,r)=>{if("OK"==e){const e=r.reduce((e,a)=>{const{PkUsera:t,LDAPLoginName:r,PrivatnostPodataka:s,AvatarPath:o,VrstaClanstvaNaziv:n,PkVrstaClanstva:i,Email:u,ImePrezimeUsera:c,ImeUsera:d,PrezimeUsera:l,LoginName:P,StatusKorisnika:m,UserAktivanDaNe:k,PkOsobniPodaciPkUsera:p,Spol:g,DatumRodenja:b,OIB:f,JMBAG:D,Mobitel:j,PkDrzava:C,Grad:E,Adresa:v,IDDrzaveNN:A,NazivDrzave:I,...N}=a,y={PkUsera:t,LDAPLoginName:r,PrivatnostPodataka:s,AvatarPath:o,VrstaClanstvaNaziv:n,PkVrstaClanstva:i,Email:u,ImePrezimeUsera:c,ImeUsera:d,PrezimeUsera:l,LoginName:P,StatusKorisnika:m,UserAktivanDaNe:k,PkOsobniPodaciPkUsera:p,Spol:g,DatumRodenja:b,OIB:f,JMBAG:D,Mobitel:j,PkDrzava:C,Grad:E,Adresa:v,IDDrzaveNN:A,NazivDrzave:I};return e.osobniPodaci||(e.osobniPodaci=y),e.profile?e.profile=[...e.profile,N]:e.profile=[N],e},{});return e.profile&&(e.profile=c(e.profile,"PkOsobniPodaciVrsta")),a.status(200).send(e)}return a.status(500).send({message:null})})}),r.post("/upsertOsobniPodaci",async function(e,a){const{request:t,conn:r}=D(e,a);await i(e,a);o.execStoredProcFromNode(t,r,a,(e,t,r)=>n(e,t,r,a))}),r.put("/profile",function(e,a){return a.status(500).send({message:"Implement me: router.put('/profile')"})}),r.delete("/profile",function(e,a){return a.status(500).send({message:"Implement me: router.delete('/profile')"})}),r.get("/osobniPodaciVrste",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("[AP].[spOsobniPodaciVrsta_Select]",t,a);r.addParameter("PkOsobniPodaciVrsta",s.Int,e.query.PkOsobniPodaciVrsta),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/getDrzave",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("[AP].[spDrzave_Select]",t,a);r.addParameter("PkDrzava",s.Int,e.query.PkDrzava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/profileVrsta",(e,a)=>{const{PkOsobniPodaciObrazovanjeRadnoIskustvo:t,PkOsobniPodaciKompetencijaNapredovanje:r}=e.query;if(t){const e=o.createConnection(a.locals.currDatabase),r=o.createRequest("Alumni.[spOsobniPodaciObrazovanjeRadnoIskustvo_select]",e,a);r.addParameter("PkOsobniPodaciObrazovanjeRadnoIskustvo",s.Int,t),o.execStoredProcFromNode(r,e,a,(e,t,r)=>n(e,t,r,a))}else if(r){const e=o.createConnection(a.locals.currDatabase),t=o.createRequest("Alumni.[spOsobniPodaciKompetencijaNapredovanje_select]",e,a);t.addParameter("PkOsobniPodaciKompetencijaNapredovanje",s.Int,r),o.execStoredProcFromNode(t,e,a,(e,t,r)=>n(e,t,r,a))}}),r.post("/profileVrsta",async function(e,a){const{PkOsobniPodaciVrsta:t}=e.body,r=await i(e,a),n=()=>{const{Opis:n,PeriodDo:i,PeriodOd:u,PkOsobniPodaciPkUsera:c,StupanjObrazovanjaIliZanimanje:d,UstanovaIMjesto:l,OsobniPodaciVrstaNaziv:P,PkOsobniPodaciObrazovanjeRadnoIskustvo:m}=e.body,k=o.createConnection(a.locals.currDatabase),p=o.createRequest("Alumni.[spOsobniPodaciObrazovanjeRadnoIskustvo_insert]",k,a);p.addParameter("UstanovaIMjesto",s.NVarChar,l),p.addParameter("StupanjObrazovanjaIliZanimanje",s.NVarChar,d),p.addParameter("PeriodOd",s.Date,u),p.addParameter("PeriodDo",s.Date,i),p.addParameter("Opis",s.NVarChar,n),p.addParameter("PkOsobniPodaciVrsta",s.Int,t),p.addParameter("PkOsobniPodaciPkUsera",s.Int,c),p.addParameter("UserZadnjePromjene",s.NVarChar,r.ImePrezimeUsera),p.addOutputParameter("PkOsobniPodaciObrazovanjeRadnoIskustvo",s.Int,null),o.execStoredProcFromNode(p,k,a,(e,t,r)=>{if("OK"==e){const{PkOsobniPodaciObrazovanjeRadnoIskustvo:e}=t;a.status(200).send({PkOsobniPodaciObrazovanjeRadnoIskustvo:e})}else a.status(500).send({message:"STD:INVALID_REQUEST"})})},u=()=>{const{KompetencijaIliNapredovanje:t,Opis:n,OsobniPodaciVrstaNaziv:i,PkOsobniPodaciVrsta:u,PkOsobniPodaciKompetencijaNapredovanje:c,PkOsobniPodaciPkUsera:d}=e.body,l=o.createConnection(a.locals.currDatabase),P=o.createRequest("Alumni.[spOsobniPodaciKompetencijaNapredovanje_insert]",l,a);P.addParameter("KompetencijaIliNapredovanje",s.NVarChar,t),P.addParameter("Opis",s.NVarChar,n),P.addParameter("PkOsobniPodaciVrsta",s.Int,u),P.addParameter("PkOsobniPodaciPkUsera",s.Int,d),P.addParameter("UserZadnjePromjene",s.NVarChar,r.ImePrezimeUsera),P.addOutputParameter("PkOsobniPodaciKompetencijaNapredovanje",s.Int,null),o.execStoredProcFromNode(P,l,a,(e,t,r)=>{if("OK"==e){const{PkOsobniPodaciKompetencijaNapredovanje:e}=t;a.status(200).send({PkOsobniPodaciKompetencijaNapredovanje:e})}else a.status(500).send({message:"STD:INVALID_REQUEST"})})};if(t)switch(t){case 1:case 2:n();break;case 3:case 4:case 5:u();break;default:a.status(500).send({message:"STD:INVALID_REQUEST"})}else a.status(500).send({message:"STD:INVALID_REQUEST"})}),r.put("/profileVrsta",async function(e,a){const{PkOsobniPodaciVrsta:t}=e.body,r=await i(e,a),n=()=>{const{Opis:n,PeriodDo:i,PeriodOd:u,PkOsobniPodaciPkUsera:c,StupanjObrazovanjaIliZanimanje:d,UstanovaIMjesto:l,OsobniPodaciVrstaNaziv:P,PkOsobniPodaciObrazovanjeRadnoIskustvo:m}=e.body,k=o.createConnection(a.locals.currDatabase),p=o.createRequest("Alumni.[spOsobniPodaciObrazovanjeRadnoIskustvo_update]",k,a);p.addParameter("UstanovaIMjesto",s.NVarChar,l),p.addParameter("StupanjObrazovanjaIliZanimanje",s.NVarChar,d),p.addParameter("PeriodOd",s.Date,u),p.addParameter("PeriodDo",s.Date,i),p.addParameter("Opis",s.NVarChar,n),p.addParameter("PkOsobniPodaciVrsta",s.Int,t),p.addParameter("PkOsobniPodaciPkUsera",s.Int,c),p.addParameter("UserZadnjePromjene",s.NVarChar,r.ImePrezimeUsera),p.addParameter("PkOsobniPodaciObrazovanjeRadnoIskustvo",s.Int,m),o.execStoredProcFromNode(p,k,a,(e,t,r)=>{"OK"==e?a.status(200).send({PkOsobniPodaciObrazovanjeRadnoIskustvo:m}):a.status(500).send({message:"STD:INVALID_REQUEST"})})},u=()=>{const{KompetencijaIliNapredovanje:t,Opis:n,OsobniPodaciVrstaNaziv:i,PkOsobniPodaciVrsta:u,PkOsobniPodaciKompetencijaNapredovanje:c,PkOsobniPodaciPkUsera:d}=e.body,l=o.createConnection(a.locals.currDatabase),P=o.createRequest("Alumni.[spOsobniPodaciKompetencijaNapredovanje_update]",l,a);P.addParameter("PkOsobniPodaciKompetencijaNapredovanje",s.Int,c),P.addParameter("KompetencijaIliNapredovanje",s.NVarChar,t),P.addParameter("Opis",s.NVarChar,n),P.addParameter("PkOsobniPodaciVrsta",s.Int,u),P.addParameter("PkOsobniPodaciPkUsera",s.Int,d),P.addParameter("UserZadnjePromjene",s.NVarChar,r.ImePrezimeUsera),o.execStoredProcFromNode(P,l,a,(e,t,r)=>{"OK"==e?a.status(200).send({PkOsobniPodaciKompetencijaNapredovanje:c}):a.status(500).send({message:"STD:INVALID_REQUEST"})})};if(t)switch(t){case 1:case 2:n();break;case 3:case 4:case 5:u();break;default:a.status(500).send({message:"STD:INVALID_REQUEST"})}else a.status(500).send({message:"STD:INVALID_REQUEST"})}),r.delete("/profileVrsta",function(e,a){const{PkOsobniPodaciKompetencijaNapredovanje:t,PkOsobniPodaciObrazovanjeRadnoIskustvo:r}=e.query;if(u(t)){const e=o.createConnection(a.locals.currDatabase),r=o.createRequest("Alumni.[spOsobniPodaciKompetencijaNapredovanje_delete]",e,a);r.addParameter("PkOsobniPodaciKompetencijaNapredovanje",s.Int,t),o.execStoredProcFromNode(r,e,a,(e,t,r)=>n(e,t,r,a))}else if(u(r)){const e=o.createConnection(a.locals.currDatabase),t=o.createRequest("Alumni.[spOsobniPodaciObrazovanjeRadnoIskustvo_delete]",e,a);t.addParameter("PkOsobniPodaciObrazovanjeRadnoIskustvo",s.Int,r),o.execStoredProcFromNode(t,e,a,(e,t,r)=>n(e,t,r,a))}else a.status(500).send({message:"STD:INVALID_REQUEST"})}),r.post("/uploadCoverImage",async function(e,a){await i(e,a);const t=new k.IncomingForm,r=d(["uploads","tempFiles","korisnici","avatar"]);t.uploadDir=r,t.keepExtensions=!0;try{t.parse(e,function(e,t,{file:r}){try{const e=d(["public","korisnici",t.PkOsobniPodaciPkUsera,"avatar/"]),i=b(),u=g.readdirSync(e);for(const a of u)g.unlinkSync(p.join(e,a));const c=`korisnici/${t.PkOsobniPodaciPkUsera}/avatar/${i}_${r.name}`;g.renameSync(r.path,`${e}${i}_${r.name}`);const P=o.createConnection(a.locals.currDatabase),m=o.createRequest("[Alumni].[spOsobniPodaciAvatar_update]",P,a);m.addParameter("PkOsobniPodaciPkUsera",s.Int,l(t.PkOsobniPodaciPkUsera)),m.addParameter("AvatarPath",s.NVarChar,c),o.execStoredProcFromNode(m,P,a,(e,t,r)=>n(e,t,r,a))}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}}),r.get("/attachments",function(e,a){const{PkOsobniPodaciPkUsera:t}=e.query,r=o.createConnection(a.locals.currDatabase),n=o.createRequest("Alumni.[spOsobniPodaciPrilozi_select]",r,a);n.addParameter("PkOsobniPodaciPkUsera",s.Int,t),o.execStoredProcFromNode(n,r,a,(e,t,r)=>{if("OK"==e){const e=r.map(e=>P(e));return a.status(200).send(e)}return a.status(500).send({message:"STD:INVALID_REQUEST"})})}),r.get("/uploadedFile",function(e,a){const{file:t}=e.query,r=p.join(global.appConfig.directoryParams.uploadPath,t);g.existsSync(r)?a.status(200).sendFile(r):a.status(400).send("STD:INVALID_REQUEST")}),r.post("/attachment",async function(e,a){const t=await i(e,a),r=new k.IncomingForm,s=d(["uploads","tempFiles","korisnici","attachment"]);r.uploadDir=s,r.keepExtensions=!0;try{r.parse(e,async function(e,r,{CoverImage:i,file:c}){try{const{Naziv:e,Opis:P,PkOsobniPodaciPkUsera:m}=r,k=b(),p=d(["uploads","korisnici",m,"attachments",`${k}/`]),f=`korisnici/${m}/attachments/${k}/`,D=i?`korisnici/${m}/attachments/${k}/${k}_${i.name}`:null,E=`korisnici/${m}/attachments/${k}/${k}_${c.name}`;i&&g.renameSync(i.path,`${p}${k}_${i.name}`),g.renameSync(c.path,`${p}${k}_${c.name}`),g.removeSync(s);const v=({dbPath:e,dbSavePathRoot:t,user:r,filename:s,file:n,Naziv:i,Opis:u,PkOsobniPodaciPkUsera:c})=>new Promise(c=>{const{size:d,path:l,name:P,type:m,hash:k,lastModifiedDate:p}=n,{conn:g,request:b}=j({Naziv:i,Opis:u,PkDatoteka:null,PkUseraPromjena:r.PkUsera,PkUseraUnos:r.PkUsera,UserPromjena:r.ImePrezimeUsera,UserUnos:r.ImePrezimeUsera,destination:t,encoding:null,filename:s,mimetype:m,originalname:P,path:e,size:d},a);o.execStoredProcFromNode(b,g,a,(e,a,t)=>{if("OK"==e){const{PkDatoteka:e}=a;c({PkDatoteka:e})}else c({PkDatoteka:null})})});let A=null;if(i){const{PkDatoteka:a}=await v({Naziv:e,Opis:P,PkOsobniPodaciPkUsera:m,dbPath:D,filename:`${k}_${i.name}`,dbSavePathRoot:f,user:t,file:i});A=u(a)?a:null}const{PkDatoteka:I}=await v({Naziv:e,Opis:P,PkOsobniPodaciPkUsera:m,dbPath:E,filename:`${k}_${c.name}`,dbSavePathRoot:f,user:t,file:c}),{conn:N,request:y}=C({PkForumObjava:null,PkResursObjava:null,PkDatoteka:I,PkDatotekaCoverImage:A,PkUsera:l(m)},a);o.execStoredProcFromNode(y,N,a,(e,t,r)=>n(e,t,r,a))}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}}),r.delete("/deletePrilog",async function(e,a){try{const{PkDatoteka:t}=e.query,r=(await E({PkDatoteka:t},a)).map(e=>((e=P(e)).Datoteka.path=p.join(global.appConfig.directoryParams.uploadPath,e.Datoteka.path),e.Datoteka.destination=p.join(global.appConfig.directoryParams.uploadPath,e.Datoteka.destination),e));r.map(({Datoteka:e})=>{g.existsSync(e.path)&&g.removeSync(e.path)});const[s]=r;g.existsSync(s.Datoteka.destination)&&g.rmdirSync(s.Datoteka.destination);for(const{Relacija:e}of r)await v(e,a);a.status(200).send({message:"OK"})}catch(e){a.status(500).send(e)}}),r.put("/editPrilog",function(e,a){const{PkDatoteka:t,Naziv:r,Opis:i}=e.body,u=o.createConnection(a.locals.currDatabase),c=o.createRequest("Alumni.spDatoteka_update",u,a);c.addParameter("PkDatoteka",s.Int,t),c.addParameter("Naziv",s.NVarChar,r),c.addParameter("Opis",s.NVarChar,i),o.execStoredProcFromNode(c,u,a,(e,t,r)=>n(e,t,r,a))}),r.get("/vrstaClanstva",function(e,a){const{PkVrstaClanstva:t}=e.query,r=o.createConnection(a.locals.currDatabase),i=o.createRequest("Alumni.spVrstaClanstva_Select",r,a);i.addParameter("PkVrstaClanstva",s.Int,t),o.execStoredProcFromNode(i,r,a,(e,t,r)=>n(e,t,r,a))}),r.get("/vrstaClanstvaAll",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Alumni.spVrstaClanstva_SelectAll",t,a);o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/obavijestVidljivost",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Alumni.spObavijestVidljivost_Select",t,a);r.addParameter("PkObavijest",s.Int,e.query.PkObavijest),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/clanoviVrsta",function(e,a){const{PkVrstaClanstva:t,query:r,skip:n,take:i}=e.query,u=o.createConnection(a.locals.currDatabase),c=o.createRequest("Alumni.spClanovi_select",u,a);c.addParameter("PkVrstaClanstva",s.Int,t),c.addParameter("skip",s.Int,n||0),c.addParameter("take",s.Int,i||6),c.addParameter("Search",s.NVarChar,r||null),o.execStoredProcFromNode(c,u,a,(e,t,r)=>{if("OK"==e){const e=r.map(e=>P(e)).map(e=>(e.osobniPodaci.PkUsera=f.encryptString(""+e.osobniPodaci.PkUsera),e));a.status(200).send(e)}else a.status(500).send({message:"STD:INVALID_REQUEST"})})}),r.get("/clanoviDataForExcelExport",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Alumni.spClanoviDataForExcelExport_select",t,a);o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.post("/ProfileLog",async function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Logs.spLogOsobniPodaci_insert",t,a);r.addParameter("PkUsera",s.Int,e.body.PkUsera),r.addParameter("Akcija",s.NVarChar,e.body.Akcija),r.addParameter("Podaci",s.NVarChar,e.body.Podaci),r.addParameter("PkUseraPristupio",s.Int,l(e.body.PkUseraPristupio)),o.execStoredProcFromNode(r,t,a,(e,t,r)=>{"OK"==e?a.status(200).send():a.status(500).send({message:"STD:INVALID_REQUEST"})})}),e.exports=r},"./src/api/resursi.js":function(e,a,t){const r=t("express").Router(),{TYPES:s}=t("tedious"),o=t("./src/db.js"),{simpleDbResolve:n,handleRequestUser:i,constructDirDepth:u,decryptIfEncrypted:c,exists:d,groupFlatProperies:l,groupDataByKeySync:P,hasClaim:m}=t("./src/services/app.service.js"),k=t("formidable"),p=(t("path"),t("fs-extra")),g=t("./src/kripto.js"),{uuid:b}=t("uuidv4"),{createDatotekaInsertRequest:f,createDatotekaRelacijaRequest:D}=t("./src/services/profile.service.js"),j="eBiblioteka";function C({request:e,conn:a,res:t}){return new Promise(r=>{o.execStoredProcFromNode(e,a,t,(e,a,t)=>{r("OK"==e?t:{message:e})})})}r.get("/ResursiKategorije",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursKategorija_Select",t,a);r.addParameter("PkResursKategorija",s.Int,e.query.PkResursKategorija),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/ResursiPotkategorije",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursPotKategorija_Select",t,a);r.addParameter("PkResursKategorija",s.Int,e.query.PkResursKategorija),e.query.skip&&r.addParameter("skip",s.Int,e.query.skip),e.query.take&&r.addParameter("take",s.Int,e.query.take),e.query.query&&r.addParameter("query",s.NVarChar,e.query.query),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/ResursiKomentari",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursKomentar_Select",t,a);r.addParameter("PkResursObjava",s.Int,e.query.PkResursObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>{if("OK"==e){r=r.map(e=>{const{groupId:a,PkObjavaOccurence:t}=e;return Object.keys(e).forEach(r=>{if(r.includes(a)){const[s,o]=r.split(a),n=`${s}.${t-1}.${o}`;delete Object.assign(e,{[n]:e[r]})[r]}}),e});const e=P(r,"PkResursKomentar");return r=(r=Object.keys(e).map(a=>({...e[a].reduce((e,a)=>({...e,...a}),{})}))).map(e=>l(e)),a.status(200).send(r)}return a.status(500).send({message:"STD:INVALID_REQUEST"})})}),r.get("/ResursiKomentar",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursKomentar_Select",t,a);r.addParameter("PkResursKomentar",s.Int,e.query.PkResursKomentar),r.addParameter("PkResursObjava",s.Int,e.query.PkResursObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>{if("OK"==e){r=r.map(e=>{const{groupId:a,PkObjavaOccurence:t}=e;return Object.keys(e).forEach(r=>{if(r.includes(a)){const[s,o]=r.split(a),n=`${s}.${t-1}.${o}`;delete Object.assign(e,{[n]:e[r]})[r]}}),e});const e=P(r,"PkResursKomentar");return r=(r=Object.keys(e).map(a=>({...e[a].reduce((e,a)=>({...e,...a}),{})}))).map(e=>l(e)),a.status(200).send(r)}return a.status(500).send({message:"STD:INVALID_REQUEST"})})}),r.get("/ResursiObjave",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursObjava_Select",t,a);e.query.PkResursObjava&&r.addParameter("PkResursObjava",s.Int,e.query.PkResursObjava),e.query.PkResursKategorija&&r.addParameter("PkResursKategorija",s.Int,e.query.PkResursKategorija),e.query.skip&&r.addParameter("skip",s.Int,e.query.skip),e.query.take&&r.addParameter("take",s.Int,e.query.take),e.query.query&&r.addParameter("query",s.NVarChar,e.query.query),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}),r.get("/ResursiObjavaPrilozi",function(e,a){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursObjavaPrilozi_select",t,a);e.query.PkResursObjava&&r.addParameter("PkResursObjava",s.Int,e.query.PkResursObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>"OK"==e?a.status(200).send(r.map(e=>l(e))):a.status(500).send({message:"STD:INVALID_REQUEST"}))}),r.post("/ResursiKategorija",async function(e,a){if(await m({modul:j,claim:"Kategorija"},e)){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Resursi.spResursKategorija_Insert",r,a);u.addParameter("Naziv",s.NVarChar,e.body.Naziv),u.addParameter("Opis",s.NVarChar,e.body.Opis),u.addParameter("UserUnos",s.NVarChar,t.ImePrezimeUsera),u.addParameter("PkUserUnos",s.Int,t.PkUsera),u.addParameter("ParentPk",s.Int,e.body.ParentPk),e.body.PublicDaNe&&u.addParameter("PublicDaNe",s.Int,e.body.PublicDaNe),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.post("/ResursiKomentar",async function(e,a){if(await m({modul:j,claim:"Komentar"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursKomentar_Insert",t,a);r.addParameter("Sadrzaj",s.NVarChar,e.body.Sadrzaj),r.addParameter("PkUseraUnos",s.Int,e.body.PkUseraUnos),r.addParameter("PkResursObjava",s.Int,e.body.PkResursObjava),r.addParameter("ParentPk",s.Int,e.body.ParentPk),r.addParameter("Dubina",s.Int,e.body.Dubina),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.post("/ResursiObjava",async function(e,a){if(await m({modul:j,claim:"Datoteka"},e)){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Resursi.spResursObjava_Insert",r,a);u.addParameter("Naslov",s.NVarChar,e.body.Naslov),u.addParameter("Sadrzaj",s.NVarChar,e.body.Sadrzaj),u.addParameter("PkUseraUnos",s.Int,t.PkUsera),u.addParameter("PkResursKategorija",s.Int,e.body.PkResursKategorija),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.post("/ResursiAttachment",async function(e,a){if(await m({modul:j,claim:"Datoteka"},e)){const t=await i(e,a),r=new k.IncomingForm,s=u(["uploads","tempFiles","korisnici","attachment"]);r.uploadDir=s,r.keepExtensions=!0;try{r.parse(e,async function(e,r,{CoverImage:i,file:l}){const{Naziv:P,Opis:m,PkObjava:k,PkOsobniPodaciPkUsera:g}=r,j=b(),C=u(["uploads","korisnici",g,"attachments","Resursi",`${k}`,`${j}/`]),E=`korisnici/${g}/attachments/Resursi/${k}/${j}/`,v=i?`korisnici/${g}/attachments/Resursi/${k}/${j}/${j}_${i.name}`:null,A=`korisnici/${g}/attachments/Resursi/${k}/${j}/${j}_${l.name}`;i&&p.renameSync(i.path,`${C}${j}_${i.name}`),p.renameSync(l.path,`${C}${j}_${l.name}`),p.removeSync(s);const I=({dbPath:e,dbSavePathRoot:t,user:r,filename:s,file:n,Naziv:i,Opis:u,PkOsobniPodaciPkUsera:c})=>new Promise(c=>{const{size:d,path:l,name:P,type:m,hash:k,lastModifiedDate:p}=n,{conn:g,request:b}=f({Naziv:i,Opis:u,PkDatoteka:null,PkUseraPromjena:r.PkUsera,PkUseraUnos:r.PkUsera,UserPromjena:r.ImePrezimeUsera,UserUnos:r.ImePrezimeUsera,destination:t,encoding:null,filename:s,mimetype:m,originalname:P,path:e,size:d},a);o.execStoredProcFromNode(b,g,a,(e,a,t)=>{if("OK"==e){const{PkDatoteka:e}=a;c({PkDatoteka:e})}else c({PkDatoteka:null})})});let N=null;if(i){const{PkDatoteka:e}=await I({Naziv:P,Opis:m,PkOsobniPodaciPkUsera:g,dbPath:v,filename:`${j}_${i.name}`,dbSavePathRoot:E,user:t,file:i});N=d(e)?e:null}const{PkDatoteka:y}=await I({Naziv:P,Opis:m,PkOsobniPodaciPkUsera:g,dbPath:A,filename:`${j}_${l.name}`,dbSavePathRoot:E,user:t,file:l}),{conn:S,request:U}=D({PkForumObjava:null,PkResursObjava:k,PkDatoteka:y,PkDatotekaCoverImage:N,PkUsera:c(g),PkForumObjavaKomentar:null,PkResursObjavaKomentar:null},a);o.execStoredProcFromNode(U,S,a,(e,t,r)=>n(e,t,r,a))})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.post("/ResursiAttachment/comment",async function(e,a){if(await m({modul:j,claim:"Komentar"},e)){const t=await i(e,a),r=new k.IncomingForm,n=u(["uploads","tempFiles","korisnici","attachment"]);r.uploadDir=n,r.keepExtensions=!0,r.multiples=!0;try{r.parse(e,async function(e,r,i){r=l(r);const{prilogDummyPk:P}=r;i=l(i);const{PkResursObjava:m,Sadrzaj:k,UserUnos:j,ParentPk:E,Dubina:v}=r;let{PkUsera:A}=t,I=d(E)?E:null,N=d(v)?v:null;const{PkResursKomentar:y}=await async function({Sadrzaj:e,PkUseraUnos:a,PkResursObjava:t,ParentPk:r=null,Dubina:n=null},i){return new Promise((u,c)=>{const d=o.createConnection(i.locals.currDatabase),l=o.createRequest("Resursi.spResursKomentar_Insert",d,i);l.addParameter("Sadrzaj",s.NVarChar,e),l.addParameter("PkUseraUnos",s.Int,a),l.addParameter("PkResursObjava",s.Int,t),l.addParameter("ParentPk",s.Int,r),l.addParameter("Dubina",s.Int,n),l.addOutputParameter("PkResursKomentar",s.Int,null),o.execStoredProcFromNode(l,d,i,(e,a,t)=>{if("OK"==e){const{PkResursKomentar:e}=a;u({PkResursKomentar:e})}else u({PkDatoteka:null})})})}({Sadrzaj:k,PkResursObjava:m,PkUseraUnos:A,Dubina:N,ParentPk:I},a);if(P){A=g.encryptString(""+A);const e=P.map(e=>({file:i.file[+e],...i.CoverImage&&{CoverImage:i.CoverImage[+e]},Naziv:r.NazivDatotekaMeta[+e],Opis:r.OpisDatotekaMeta[+e]})).filter(e=>e);for(const{file:r,CoverImage:s,Naziv:n,Opis:i}of e){const e=b(),l=u(["uploads","korisnici",`${A}`,"attachments","Resursi",`${m}`,"comment",`${e}/`]),P=`korisnici/${A}/attachments/Resursi/${m}/comment/${e}/`,k=s?`korisnici/${A}/attachments/Resursi/${m}/comment/${e}/${e}_${s.name}`:null,g=`korisnici/${A}/attachments/Resursi/${m}/comment/${e}/${e}_${r.name}`;s&&p.renameSync(s.path,`${l}${e}_${s.name}`),p.renameSync(r.path,`${l}${e}_${r.name}`);const j=({dbPath:e,dbSavePathRoot:t,user:r,filename:s,file:n,Naziv:i,Opis:u,PkOsobniPodaciPkUsera:c})=>new Promise(c=>{const{size:d,path:l,name:P,type:m,hash:k,lastModifiedDate:p}=n,{conn:g,request:b}=f({Naziv:i,Opis:u,PkDatoteka:null,PkUseraPromjena:r.PkUsera,PkUseraUnos:r.PkUsera,UserPromjena:r.ImePrezimeUsera,UserUnos:r.ImePrezimeUsera,destination:t,encoding:null,filename:s,mimetype:m,originalname:P,path:e,size:d},a);o.execStoredProcFromNode(b,g,a,(e,a,t)=>{if("OK"==e){const{PkDatoteka:e}=a;c({PkDatoteka:e})}else c({PkDatoteka:null})})});let E=null;if(s){const{PkDatoteka:a}=await j({Naziv:n,Opis:i,PkOsobniPodaciPkUsera:A,dbPath:k,filename:`${e}_${s.name}`,dbSavePathRoot:P,user:t,file:s});E=d(a)?a:null}const{PkDatoteka:v}=await j({Naziv:n,Opis:i,PkOsobniPodaciPkUsera:A,dbPath:g,filename:`${e}_${r.name}`,dbSavePathRoot:P,user:t,file:r}),{conn:I,request:N}=D({PkResursObjava:m,PkDatoteka:v,PkDatotekaCoverImage:E,PkUsera:c(A),PkResursObjavaKomentar:y},a);await C({request:N,conn:I,res:a})}}p.removeSync(n),a.status(200).send({PkResursKomentar:y})})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.post("/ResursiAttachment/objava",async function(e,a){if(await m({modul:j,claim:"Datoteka"},e)){const t=await i(e,a),r=new k.IncomingForm,n=u(["uploads","tempFiles","korisnici","attachment"]);r.uploadDir=n,r.keepExtensions=!0,r.multiples=!0;try{r.parse(e,async function(e,r,i){r=l(r);const{prilogDummyPk:P}=r;i=l(i);const{Naslov:m,Sadrzaj:k,PkResursKategorija:j}=r;let{PkUsera:E}=t;const{PkResursObjava:v}=await async function({Naslov:e,Sadrzaj:a,PkUseraUnos:t,PkResursKategorija:r},n){return new Promise((i,u)=>{const c=o.createConnection(n.locals.currDatabase),d=o.createRequest("Resursi.spResursObjava_Insert",c,n);d.addParameter("Naslov",s.NVarChar,e),d.addParameter("Sadrzaj",s.NVarChar,a),d.addParameter("PkUseraUnos",s.Int,t),d.addParameter("PkResursKategorija",s.Int,r),d.addOutputParameter("PkResursObjava",s.Int,null),o.execStoredProcFromNode(d,c,n,(e,a,t)=>{if("OK"==e){const{PkResursObjava:e}=a;i({PkResursObjava:e})}else i({PkDatoteka:null})})})}({Naslov:m,Sadrzaj:k,PkUseraUnos:E,PkResursKategorija:j},a);if(P){E=g.encryptString(""+E);const e=P.map(e=>({file:i.file[+e],...i.CoverImage&&{CoverImage:i.CoverImage[+e]},Naziv:r.NazivDatotekaMeta[+e],Opis:r.OpisDatotekaMeta[+e]})).filter(e=>e);for(const{file:r,CoverImage:s,Naziv:n,Opis:i}of e){const e=b(),l=u(["uploads","korisnici",`${E}`,"attachments","Resursi",`${v}`,`${e}/`]),P=`korisnici/${E}/attachments/Resursi/${v}/${e}/`,m=s?`korisnici/${E}/attachments/Resursi/${v}/${e}/${e}_${s.name}`:null,k=`korisnici/${E}/attachments/Resursi/${v}/${e}/${e}_${r.name}`;s&&p.renameSync(s.path,`${l}${e}_${s.name}`),p.renameSync(r.path,`${l}${e}_${r.name}`);const g=({dbPath:e,dbSavePathRoot:t,user:r,filename:s,file:n,Naziv:i,Opis:u,PkOsobniPodaciPkUsera:c})=>new Promise(c=>{const{size:d,path:l,name:P,type:m,hash:k,lastModifiedDate:p}=n,{conn:g,request:b}=f({Naziv:i,Opis:u,PkDatoteka:null,PkUseraPromjena:r.PkUsera,PkUseraUnos:r.PkUsera,UserPromjena:r.ImePrezimeUsera,UserUnos:r.ImePrezimeUsera,destination:t,encoding:null,filename:s,mimetype:m,originalname:P,path:e,size:d},a);o.execStoredProcFromNode(b,g,a,(e,a,t)=>{if("OK"==e){const{PkDatoteka:e}=a;c({PkDatoteka:e})}else c({PkDatoteka:null})})});let j=null;if(s){const{PkDatoteka:a}=await g({Naziv:n,Opis:i,PkOsobniPodaciPkUsera:E,dbPath:m,filename:`${e}_${s.name}`,dbSavePathRoot:P,user:t,file:s});j=d(a)?a:null}const{PkDatoteka:A}=await g({Naziv:n,Opis:i,PkOsobniPodaciPkUsera:E,dbPath:k,filename:`${e}_${r.name}`,dbSavePathRoot:P,user:t,file:r}),{conn:I,request:N}=D({PkResursObjava:v,PkDatoteka:A,PkDatotekaCoverImage:j,PkUsera:c(E)},a);await C({request:N,conn:I,res:a})}}p.removeSync(n),a.status(200).send({PkResursObjava:v})})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.put("/ResursiKategorija",async function(e,a){if(await m({modul:j,claim:"Kategorija"},e)){const t=await i(e,a),r=o.createConnection(a.locals.currDatabase),u=o.createRequest("Resursi.spResursKategorija_Update",r,a);u.addParameter("PkResursKategorija",s.Int,e.body.PkResursKategorija),u.addParameter("Naziv",s.NVarChar,e.body.Naziv),u.addParameter("Opis",s.NVarChar,e.body.Opis),u.addParameter("UserPromjenio",s.NVarChar,t.ImePrezimeUsera),u.addParameter("PkUseraPromjenio",s.Int,t.PkUsera),u.addParameter("RowVersion",s.NVarChar,e.body.RowVersion),o.execStoredProcFromNode(u,r,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.put("/ResursiKomentar",async function(e,a){if(await m({modul:j,claim:"Komentar"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursKomentar_Update",t,a);r.addParameter("Sadrzaj",s.NVarChar,e.body.Sadrzaj),r.addParameter("PkResursKomentar",s.Int,e.body.PkResursKomentar),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.put("/ResursiObjava",async function(e,a){if(await m({modul:j,claim:"Datoteka"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursObjava_Update",t,a);r.addParameter("Naslov",s.NVarChar,e.body.Naslov),r.addParameter("Sadrzaj",s.NVarChar,e.body.Sadrzaj),r.addParameter("PkResursObjava",s.Int,e.body.PkResursObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.delete("/ResursiKategorija",async function(e,a){if(await m({modul:j,claim:"Kategorija"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursKategorija_Delete",t,a);r.addParameter("PkResursKategorija",s.Int,e.query.PkResursKategorija),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.delete("/ResursiKomentar",async function(e,a){if(await m({modul:j,claim:"Komentar"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursKomentar_Delete",t,a);r.addParameter("PkResursKomentar",s.Int,e.query.PkResursKomentar),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),r.delete("/ResursiObjava",async function(e,a){if(await m({modul:j,claim:"Datoteka"},e)){const t=o.createConnection(a.locals.currDatabase),r=o.createRequest("Resursi.spResursObjava_Delete",t,a);r.addParameter("PkResursObjava",s.Int,e.query.PkResursObjava),o.execStoredProcFromNode(r,t,a,(e,t,r)=>n(e,t,r,a))}else a.status(401).send({message:"STD:UNATHORIZED_ACCES"})}),e.exports={resursiRouter:r}},"./src/config/appConfig.js":function(e,a,t){var r=t("app-root-path"),s=t("fs");global.appConfig={encryptionConfig:{enkripcijaDaNe:!0,encryptColumns:["PkUsera","PkOsobniPodaciPkUsera","PkUseraUnos"]}};var o=s.readFileSync("./config/appConfigExt.json","utf8");o=JSON.parse(o.toString());var n=s.readFileSync("./config/appConfig4App.json","utf8");n=JSON.parse(n.toString()),global.appConfig={...global.appConfig,...o,...n},global.appConfig.appRootPath=r;var i=global.appConfig;e.exports=i},"./src/db.js":function(e,a,t){var r=[],s=t("./src/kripto.js"),o=t("tedious-connection-pool"),n={server:global.appConfig.databaseParams.productionDatabaseServer,userName:s.decryptString(global.appConfig.databaseParams.productionUserName),password:s.decryptString(global.appConfig.databaseParams.productionPassword),options:{encrypt:!0,database:global.appConfig.databaseParams.productionDatabaseName,instanceName:global.appConfig.databaseParams.productionDatabaseServerInstanceName,trustServerCertificate:!0},authentication:{type:"default",options:{userName:s.decryptString(global.appConfig.databaseParams.productionUserName),password:s.decryptString(global.appConfig.databaseParams.productionPassword)}}},i={server:global.appConfig.databaseParams.testDatabaseServer,userName:s.decryptString(global.appConfig.databaseParams.testUserName),password:s.decryptString(global.appConfig.databaseParams.testPassword),options:{encrypt:!0,database:global.appConfig.databaseParams.testDatabaseName,instanceName:global.appConfig.databaseParams.testDatabaseServerInstanceName},authentication:{type:"default",options:{userName:s.decryptString(global.appConfig.databaseParams.testUserName),password:s.decryptString(global.appConfig.databaseParams.testPassword)}}},u={min:2,max:4,log:!1,acquireTimeout:3e5};let c,d;!function(){try{(c=new o(u,n)).on("error",function(e){c.drain()}),c.on("debug",(e,a)=>{global.systemLogger.log({level:"error",message:" pool error  "+e+a})}),e.exports.pool=c,(d=new o(u,i)).on("error",function(e){d.drain()}),d.on("debug",(e,a)=>{global.systemLogger.log({level:"error",message:" pool4Test error  "+e+a})}),e.exports.pool4Test=d}catch(e){global.systemLogger.log({level:"error",message:"create pool error  "+e})}}(),e.exports.createConnection=function(e){try{var a=t("tedious").Connection;if("Testna baza podataka"===e)var r=new a(i);else r="Produkcijska baza podataka"===e?new a(n):null;return r.connect(),r}catch(e){return global.systemLogger.log({level:"error",message:" SQL Create Connection error  "+e}),r=null}},e.exports.pool=c,e.exports.pool4Test=d,e.exports.createRequest=function(e,a,r){return new(0,t("tedious").Request)(e,function(e,t){if(e&&(global.systemLogger.log({level:"error",message:"SQL Create Req error "+e.message}),r&&!r.finished&&!r.headersSent))try{r.status(503).send({message:"STD:CHECK_INTERNET_OR_VPN"})}catch(e){global.systemLogger.log({level:"error",message:"SQL Create Req error "+(e&&e.message)})}a&&a.close()})},e.exports.createRequestPool=function(e,a){return new(0,t("tedious").Request)(e,function(e,t){e&&global.systemLogger.log({level:"error",message:"SQL Create POOL Req error "+e.message}),a.release()})},e.exports.execStoredProc=function(e,a,t,r,o){var n=e,i=[],u=[],c=[];"string"==typeof e&&(n=this.createRequest(e,a));var d=!0;n.on("row",function(e){d=!1;var a={};e.forEach(function(e){a[e.metadata.colName]=e.value}),c.push(a)}),n.on("doneProc",function(e,a,r,o){i.length>0&&t.status(500).write(JSON.stringify(i[0])),d&&0==i.length&&(global.appConfig.encryptionConfig.enkripcijaDaNe&&(u=s.encryptColumnsToClient(u)),"NOK"==u?t.status(500).write(JSON.stringify({message:"error"})):t.write(JSON.stringify(u))),d||0!=i.length||(c=function(e){try{for(var a=Object.keys(e),t="",r="",s=0;s<a.length;s++)r=Object.keys(e[s]),t+=e[s][r].toString();return JSON.parse(t)}catch(a){return e}}(c),global.appConfig.encryptionConfig.enkripcijaDaNe&&(c=s.encryptColumnsToClient(c)),"NOK"==c?t.status(500).write(JSON.stringify({message:"error"})):t.write(JSON.stringify(c))),u=[],t.end()}),n.on("returnValue",function(e,a,t){var r={};r[e]=a,u.push(r)}),a.on("errorMessage",function(e){e&&i.push(e)}),n.on("error",function(e){global.systemLogger.log({level:"error",message:"Req error "+e.message})}),a.on("connect",function(e){e&&console.log(e),a.callProcedure(n)})},e.exports.execStoredProcFromNode=function(e,a,t,r){var o=e,n=[],i={},u=[];o.on("doneProc",function(e,a,o,c){n.length>0&&r(t="NOK",i,u),0==n.length&&(t="OK",global.appConfig.encryptionConfig.enkripcijaDaNe&&(i=s.encryptColumnsToClient(i),u=s.encryptColumnsToClient(u)),r(t,i,u))}),o.on("row",function(e){var a={};e.forEach(function(e){a[e.metadata.colName]=e.value}),u.push(a)}),a.on("errorMessage",function(e){console.log("errorMessage"),console.log("err",e),e&&n.push(e)}),o.on("returnValue",function(e,a,t){i[e]=a}),a.on("connect",function(e){e&&console.log(e),a.callProcedure(o)})},e.exports.execStoredProcNoJSONLocalResults=function(e,a,t,o,n){var i=e,u=[];r=[],i.on("row",function(e){var a={};e.forEach(function(e){a[e.metadata.colName]=e.value}),u.push(a)}),i.on("doneProc",function(){if(global.appConfig.encryptionConfig.enkripcijaDaNe&&(u=s.encryptColumnsToClient(u)),0===r.length){if("function"!=typeof n)return{resultStatus:"0",resultData:u};n({resultStatus:"0",resultData:u},t,o)}else{if("function"!=typeof n)return{greska:r};n(r,t,o)}}),a.on("errorMessage",function(e){if(console.log("error errorMessage",e.message),e)return r={resultStatus:"9999",resultData:e},{resultStatus:e.message,resultData:e}}),a.on("connect",function(e){e&&console.log("error connect"),a.callProcedure(i)})},e.exports.createTransactionRequest=function(e,a){return new(0,t("tedious").Request)(e,function(e,a){e&&global.apiLogger.log({level:"error",message:" error in db.createTransactionRequest  "+e})})},e.exports.beginTransaction=function(e,a){e.on("connect",function(t){t&&(console.log("error in db.beginTransaction",t),global.apiLogger.log({level:"error",message:" error in db.beginTransaction  "+t})),e.beginTransaction(function(e,t){e&&(console.log("error in db.beginTransaction",e),global.apiLogger.log({level:"error",message:" error in db.beginTransaction  "+e})),t&&a()})})},e.exports.commitTransaction=function(e){e.commitTransaction(function(a){a&&(console.log("error in db.commitTransaction",a),global.apiLogger.log({level:"error",message:" error in db.commitTransaction  "+a}),e.rollbackTransaction(function(e){})),e.close()})},e.exports.execStoredProcInTransaction=function(e,a,t,r={},o){var n=e,i=[],u=[];"LoggedIn"==a.state.name&&a.callProcedure(n),n.on("row",function(e){var a={};e.forEach(function(e){a[e.metadata.colName]=e.value}),u.push(a)}),a.on("errorMessage",function(e){e&&i.push(e)}),n.on("requestCompleted",function(){i.length>0&&(t=i[0],o(t,r,u)),0==i.length&&(t="OK",global.appConfig.encryptionConfig.enkripcijaDaNe&&(r=s.encryptColumnsToClient(r),u=s.encryptColumnsToClient(u)),o(t,r,u))}),n.on("error",function(){a.rollbackTransaction(function(e){}),a.close()}),a.on("infoMessage",function(e){3621===e.number&&console.log("DeadLock",e.number,e.message,e.state)}),n.on("returnValue",function(e,a,t){r[e]=a}),a.on("connect",function(e){e&&console.log(e),a.callProcedure(n)})}},"./src/error.handler.js":function(e,a,t){const r=t("process");function s(e,a,t){switch(global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace({reason:e},{promise:a},{exceptionType:t}),t){case"unhandledRejection":global.systemLogger.log({level:"error",message:"HANDLER: Unhandled Promise Rejection caught, reason: "+e});break;case"uncaughtException":global.systemLogger.log({level:"error",message:"HANDLER: Exception caught, missing a trycatch somewhere, reason: "+e})}}e.exports={useGlobalAppHandlers:function(...e){0==e.length&&(e=["unhandledRejection","uncaughtException"]),e.includes("unhandledRejection")&&r.on("unhandledRejection",(e,a)=>s(e,a,"unhandledRejection")),e.includes("uncaughtException")&&r.on("uncaughtException",e=>s(e,null,"uncaughtException"))}}},"./src/jwt/jwt.js":function(e,a,t){const r=t("jsonwebtoken"),s=t("express-jwt"),o=t("./src/kripto.js"),n={config:null,init:function(){return this.config=JSON.parse(JSON.stringify(global.appConfig.jwtConfig)),this.decryptConfig(),this},decryptConfig:function(){this.config.decryptKeys.forEach(e=>{this.eachRecursive(this.config,e,o.decryptString)}),this.config.acceptableSecrets=this.config.acceptableSecrets.map(e=>o.decryptString(e))},eachRecursive:function(e,a,t){for(var r in e)"object"==typeof e[r]&&null!==e[r]?this.eachRecursive(e[r],a,t):r==a&&(e[r]=t(e[r]))},loginJwt:function(e){return r.sign({payload:e},this.config.jwtSecret,{expiresIn:this.config.expiresIn,algorithm:this.config.algorithm})},signJwt:function(e,a){return r.sign({payload:e},a,{expiresIn:this.config.expiresIn,algorithm:this.config.algorithm})},extractJwt:function(e){return e&&e.length?e.split(" ")[1]:null},isValidJWTToken:function(e){try{return r.verify(e,this.config.jwtSecret,{algorithms:[this.config.algorithm]}),!0}catch(e){return!1}},decodeToken:function(e){return r.decode(e)},verifyJwtAndReturnAuthData:function(e=null,a=null){return new Promise((t,r)=>{e&&null==a&&(a=this.extractJwt(e.headers.authorization)),null==a&&r(!1),this.isValidJWTToken(a)?t(this.decodeToken(a)):r(!1)})},findValidSecret:function(e,a,t){let s=(e,a)=>{try{return r.verify(e,a,{algorithms:[n.config.algorithm]}),!0}catch(e){return!1}},o=n.extractJwt(e.headers.authorization);if(null==o)return t(null,null);if(void 0!=(1==s(o,n.config.jwtSecret)?n.config.jwtSecret:void 0))return t(null,n.config.jwtSecret);let i=n.config.acceptableSecrets.find(e=>s(o,e));return t(null,void 0!=i?i:null)},jwtMiddleware:function(){return s({secret:this.findValidSecret,algorithms:[this.config.algorithm]}).unless({path:["/api/test","/api/security/test","/api/security/login",/\/public*/,"/api/obavijesti/obavijest","/api/obavijesti/obavijestCategoryGroup","/api/obavijesti/obavijestForCategoryFTS","/api/obavijesti/obavijestiKategorija","/api/obavijesti/obavijestiKategorijaAll","/api/obavijesti/obavijestForCategory","/api/forum/kategorije","/api/forum/potkategorije","/api/forum/komentari","/api/forum/objave","/api/forum/objavaPrilozi","/api/resursi/ResursiKategorije","/api/resursi/ResursiPotkategorije","/api/resursi/ResursiKomentari","/api/resursi/ResursiObjave","/api/resursi/ResursiObjavaPrilozi","/api/profile/profile","/api/profile/osobniPodaciVrste","/api/profile/getDrzave","/api/profile/profileVrsta","/api/profile/attachments","/api/profile/uploadedFile","/api/profile/vrstaClanstva","/api/profile/clanoviVrsta","/api/google/oauth","/api/ankete/ankete","/api/ankete/predlosci","/api/ankete/anketa/solved/check","/api/ankete/anketa/solved","/api/ankete/anketa/statistika","/api/ankete/predlozak/templating","/api/security/usernameExists","/api/google/oauth/complete","/api/security/appUserInsert","/api/security/findUserByUsername","/api/security/resendConfirmEmail","/api/security/verifyAccount","/api/security/sendPassChangeEmail","/api/security/resetForgottenPassword","/api/security/aaiLogin","/api/security/ldapLogin",/\/*test/]})}};n.init(),e.exports=n},"./src/jwt/security.js":function(e,a,t){var r=t("express"),s=t("request"),o=t("./src/kripto.js"),n=r.Router(),i=t("./src/db.js"),u=t("./src/jwt/jwt.js"),c=t("tedious").TYPES,d=t("./src/kripto.js");t("fs");const l=t("activedirectory2"),P=t("axios").default,{first:m}=t("rxjs"),{uuid:k}=t("uuidv4"),{sendRegistrationMail:p,sendPassResetEmail:g}=t("./src/mail/mail.js"),{handleRequestUser:b,decryptIfEncrypted:f,makeObservableConnection:D,groupFlatProperies:j}=t("./src/services/app.service.js"),{createUpsertOsobniPodaciRequest:C}=t("./src/services/profile.service.js");function E(e,a){return new Promise(t=>{const r=i.createConnection(a.locals.currDatabase),s=i.createRequest("[Sigurnost].[spApplicationUserLogin_select]",r,a);e.LoginName&&s.addParameter("LoginName",c.NVarChar,e.LoginName),e.LDAPLoginName&&s.addParameter("LDAPLoginName",c.NVarChar,e.LDAPLoginName),i.execStoredProcFromNode(s,r,a,(e,a,r)=>{const s=r.find(e=>e.IsAdmin);t(s||r[0])})})}function v(e,a){return new Promise(t=>{const r=i.createConnection(a.locals.currDatabase),s=i.createRequest("[Sigurnost].[spApplicationUser_select_NO_JSON]",r,a);s.addParameter("PkUsera",c.Int,e),i.execStoredProcFromNode(s,r,a,(e,a,r)=>{t(r[0])})})}function A(e,a){return new Promise(t=>{const r=i.createConnection(a.locals.currDatabase),s=i.createRequest("[Sigurnost].[spApplicationUserUUID_select]",r,a);s.addParameter("UUID",c.NVarChar,e),i.execStoredProcFromNode(s,r,a,(e,a,r)=>{t(r[0])})})}function I({status:e,user:a,res:t}){return new Promise(r=>{const s=i.createConnection(t.locals.currDatabase),n=i.createRequest("[Sigurnost].[spApplicationUserStatusRacuna_Update]",s,t);n.addParameter("KorisnikPkUsera",c.Int,o.decryptString(a.PkUsera)),n.addParameter("StatusKorisnika",c.Int,e),n.addParameter("AktivanDaNe",c.Int,a.UserAktivanDaNe),n.addParameter("RowVersion",c.NVarChar,a.RowVersion),i.execStoredProcFromNode(n,s,t,(e,a,t)=>{r(t[0])})})}function N({authHeader:e,OIB:a}){return new Promise(async t=>{const r=u.extractJwt(e),{API_URL:s}=global.appConfig.eduplanSync;try{const e=await P.get(s,{headers:{authorization:`Bearer ${r}`},params:{OIB:a}}),o=e&&e.data||null;t(o?j(o.user):{})}catch(e){return global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),t({})}})}function y({osobniPodaci:e,eduplanUser:a,PkUsera:t}){const{meta:r,nastavnik:s,student:o}=a,n={...r,...s&&s.PkNastavnikSuradnik?s:o};return{body:{...{...e,Spol:n.Spol?n.Spol.toLowerCase().startsWith("Mu")?"MUSKO":"ZENSKO":null,ImeUsera:n.Ime,PrezimeUsera:n.Prezime,DatumRodenja:n.DatumRodjenja||n.DatumRodenja,JMBAG:n.JMBAG||null,Email:n.Email||n.Email1||n.Email2,PkDrzava:n.PkDrzava,Grad:`${n.NazivGrada||""} ${n.PostanskiBroj||""} ${n.PostanskiBrojPA||""}`,Adresa:n.Adresa||n.AdresaKucna,Mobitel:n.BrojMobitela||n.Mobitel},PkUsera:t,PkOsobniPodaciPkUsera:t}}}const S={handleLoginPermit:(e,a)=>{if(0==e.UserAktivanDaNe)return a({message:"STD:INACTIVE_USER"});const t=function(e){switch(!0){case 0==e:return{rejectLogin:!0,message:"STD:INACTIVE_USER"};case 1==e:return{rejectLogin:!1};case 2==e:return{rejectLogin:!0,message:"STD:PASS_RESET_CHECK_MAIL"};case 3==e:return{rejectLogin:!0,message:"STD:BANNED_ACC"};default:return{rejectLogin:!0,message:"STD:INACTIVE_USER"}}}(e.StatusKorisnika);return t.rejectLogin?a({message:t.message}):null},registerInWithLDAP:function({LoginName:e,Lozinka:a},t){return new Promise((r,s)=>{const o=new l({url:global.appConfig.ldap.ActiveDirectoryApi,username:e,password:a,baseDN:global.appConfig.ldap.baseDN});o.authenticate(e,a||"wrong_pass_if_empty",async(a,n)=>{if(a)return s({message:"STD:INVALID_CREDENTIALS"});o.findUser(e,async(e,a)=>{if(e)return s({message:"STD:INVALID_CREDENTIALS"});const{sn:o,givenName:n,userPrincipalName:i,sAMAccountName:c}=a,d=await U({PrezimeUsera:o||"-",ImeUsera:n||"-",LDAPLoginName:c,LoginName:c,Lozinka:k(),ObaveznaIzmjenaLozinkeDaNe:0,Email:i,UserAktivanDaNe:1,StatusKorisnika:1},t,!1);r(u.loginJwt({...d,...{currDatabase:t.locals.currDatabase}}))})})})},signInWithLDAP:function({LoginName:e,Lozinka:a},t){return new Promise((r,s)=>{new l({url:global.appConfig.ldap.ActiveDirectoryApi}).authenticate(e,a||"wrong_pass_if_empty",async(a,o)=>{if(console.log(a,o),a)s({message:"STD:INVALID_CREDENTIALS"});else{let a=null;try{const r=e.split(global.appConfig.ldap.ldapDomena)[0];a=await E({LDAPLoginName:r},t)}catch(e){s({message:"STD:INVALID_CREDENTIALS"})}a&&(this.handleLoginPermit(a,s),r(u.loginJwt({...a,...{currDatabase:t.locals.currDatabase}}))),s({message:"STD:INVALID_CREDENTIALS"})}})})},userLogin:function(e,a,t){return new Promise(async(e,r)=>{let s=null;try{s=await E(t,a)}catch(e){r({message:"STD:INVALID_CREDENTIALS"})}s&&(this.handleLoginPermit(s,r),t.LoginName===d.decryptAdminPassword(t.Lozinka,!1)?e(u.loginJwt({...s,...{currDatabase:a.locals.currDatabase}})):t.Lozinka==d.decryptString(s.Lozinka)&&e(u.loginJwt({...s,...{currDatabase:a.locals.currDatabase}}))),r({message:"STD:INVALID_CREDENTIALS"})})},aaiLogin:function(e,a,t){return new Promise(async(e,r)=>{const{givenName:s,hrEduPersonUniqueID:o,sn:n,hrEduPersonOIB:d}=t;let l=null;try{l=await E({LoginName:o},a)}catch(e){r({message:"STD:INVALID_REQUEST"})}const P=e=>{const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Alumni].[spOsobniPodaci_select]",t,a);return r.addParameter("PkUsera",c.Int,f(e)),D(r,t,a,i)};if(l){const t=()=>{this.handleLoginPermit(l,r),e(u.loginJwt({...l,...{currDatabase:a.locals.currDatabase}}))},o=e=>!e||"-"==e;if(o(l.ImeUsera)||o(l.PrezimeUsera)||o(l.OIB)){const e=e=>{const{ImeUsera:t,PrezimeUsera:r,OIB:u}=e,P=i.createConnection(a.locals.currDatabase),m=i.createRequest("[Alumni].[spOsobniPodaci_update]",P,a);return m.addParameter("PkUsera",c.Int,f(l.PkUsera)),m.addParameter("ImeUsera",c.NVarChar,o(t)?s:t),m.addParameter("PrezimeUsera",c.NVarChar,o(r)?n:r),m.addParameter("OIB",c.NVarChar,o(u)?d:u),D(m,P,a,i)};return P(l.PkUsera).pipe(m()).subscribe(([a])=>e(a).pipe(m()).subscribe(e=>{t()}))}t()}else try{const t=await U({PrezimeUsera:n||"-",ImeUsera:s||"-",LDAPLoginName:null,LoginName:o,Lozinka:k(),ObaveznaIzmjenaLozinkeDaNe:0,Email:null,UserAktivanDaNe:1,StatusKorisnika:1},a,!1,{OIB:d||"-"});if(d){const s=await N({authHeader:`Bearer ${u.loginJwt({OIB:d})}`,OIB:d});if(s&&s.meta&&s.meta.PkUsera)return P(t.PkUsera).pipe(m()).subscribe(([n])=>{const c=y({osobniPodaci:n,eduplanUser:s,PkUsera:f(t.PkUsera)}),{request:d,conn:l}=C(c,a);D(d,l,a,i).pipe(m()).subscribe({next:async r=>{const s=await E({LoginName:o},a);e(u.loginJwt({...s,...{currDatabase:a.locals.currDatabase}})),e(u.loginJwt({...t,...{currDatabase:a.locals.currDatabase}}))},error:e=>{r({message:"STD:INVALID_REQUEST"})}})});e(u.loginJwt({...t,...{currDatabase:a.locals.currDatabase}}))}else e(u.loginJwt({...t,...{currDatabase:a.locals.currDatabase}}))}catch(e){r({message:"STD:INVALID_REQUEST"})}})}};function U(e,a,t=!0,r={}){return new Promise(async(s,o)=>{const n=i.createConnection(a.locals.currDatabase),u=i.createRequest("[Sigurnost].[spApplicationUser_insert]",n,a);u.addParameter("PrezimeUsera",c.NVarChar,e.PrezimeUsera),u.addParameter("ImeUsera",c.NVarChar,e.ImeUsera),u.addParameter("LDAPLoginName",c.NVarChar,(()=>{if(e.Email&&e.Email.includes("@"))return e.Email.split("@")[0]})()),u.addParameter("LoginName",c.NVarChar,e.LoginName),u.addParameter("Lozinka",c.NVarChar,d.encryptString(e.Lozinka)),u.addParameter("ObaveznaIzmjenaLozinkeDaNe",c.Int,e.ObaveznaIzmjenaLozinkeDaNe),u.addParameter("Email",c.NVarChar,e.Email),u.addParameter("UserAktivanDaNe",c.Int,e.UserAktivanDaNe),u.addParameter("StatusKorisnika",c.Int,e.StatusKorisnika||0),u.addParameter("UUID",c.NVarChar,k()),u.addParameter("PkUseraUnos",c.Int,null),u.addParameter("User",c.NVarChar,null),u.addParameter("Claims",c.NVarChar,e.UserClaims||JSON.stringify(global.appConfig.jwtConfig.defaultUserClaims)),u.addOutputParameter("PkUsera",c.Int,null),i.execStoredProcFromNode(u,n,a,async(e,n,u)=>{try{if("OK"==e){const{PkUsera:e}=n,o=await v(e,a);t&&p(o,a.locals.language);const{OIB:u}=r,{request:c,conn:d}=C({body:{Spol:null,ImeUsera:o.ImeUsera,PrezimeUsera:o.PrezimeUsera,DatumRodenja:null,OIB:u||null,JMBAG:null,PkDrzava:null,Grad:null,Adresa:null,Email:o.Email,Mobitel:null,LoginName:null,PkUsera:e,PkOsobniPodaciPkUsera:null}},a);i.execStoredProcFromNode(c,d,a,async(e,a,t)=>{s(o)})}else o({message:"STD:REGISTER_FAILED"})}catch(e){o(e)}})})}n.get("/test",function(e,a){a.send({message:"OK"})}),n.get("/test/auth",function(e,a){a.send(e.user)}),n.put("/syncEduplan",async function(e,a){const{osobniPodaci:t,OIB:r,PkUsera:s}=e.body,o=y({osobniPodaci:t,eduplanUser:await N({authHeader:e.headers.authorization,OIB:r}),PkUsera:s}),{request:n,conn:u}=C(o,a);D(n,u,a,i).pipe(m()).subscribe({next:e=>{a.send(o)},error:e=>{a.send(e)}})}),n.put("/refreshJWT",async function(e,a){const{token:t}=e.body,{payload:r}=u.decodeToken(t)||{};if(r){const{LoginName:e}=r,t=await E({LoginName:e},a);t&&a.send({token:u.loginJwt({...t,...{currDatabase:a.locals.currDatabase}})})}else a.send({})}),n.post("/ldapLogin",async function(e,a){if(e.body&&e.body.user){const{LoginName:t,Lozinka:r}=e.body.user;try{const e=await S.signInWithLDAP({LoginName:t+global.appConfig.ldap.ldapDomena,Lozinka:r},a);e&&a.send({token:e})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e);try{const e=await S.registerInWithLDAP({LoginName:t+global.appConfig.ldap.ldapDomena,Lozinka:r},a);e&&a.send({token:e})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e)}}}}),n.post("/login",async function(e,a){if(e.body&&e.body.user){const{LoginName:t,Lozinka:r}=e.body.user;if(t.endsWith(global.appConfig.ldap.ldapDomena))try{const e=await S.signInWithLDAP({LoginName:t,Lozinka:r},a);e&&a.send({token:e})}catch(e){global.appConfig.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e)}S.userLogin(e,a,e.body.user).then(e=>{a.send({token:e})}).catch(e=>{a.status(401).send(e)})}else a.status(401).send({message:"STD:INVALID_REQUEST"})}),n.post("/aaiLogin",function(e,a){if(e.body){const{givenName:t,hrEduPersonUniqueID:r,sn:s,hrEduPersonOIB:o}=e.body;S.aaiLogin(e,a,{givenName:t,hrEduPersonUniqueID:r,sn:s,hrEduPersonOIB:o}).then(e=>{a.send({token:e})}).catch(e=>{a.status(401).send(e)})}else a.status(401).send({message:"STD:INVALID_REQUEST"})}),n.get("/appUsers",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationUser_select]",t,a);i.execStoredProc(r,t,a,"[]")}),n.get("/appGroups",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationUserGroup_select]",t,a);i.execStoredProc(r,t,a,"[]")}),n.get("/userGroup",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationGroupZaUsera_select]",t,a);r.addParameter("PkUsera",c.Int,e.query.PkUsera),i.execStoredProc(r,t,a,"[]")}),n.get("/groupUsers",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationUserZaAppGroupu_select]",t,a);r.addParameter("PkApplicationUserGroup",c.Int,e.query.PkApplicationUserGroup),i.execStoredProc(r,t,a,"[]")}),n.post("/appGroupSetUser",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationUserApplicationUserGroup_InsertOrDelete]",t,a);r.addParameter("KorisnikPkUsera",c.Int,e.body.KorisnikPkUsera),r.addParameter("PkApplicationUserGroup",c.Int,e.body.PkApplicationUserGroup),r.addParameter("UserSePridruzujeDaNe",c.Int,e.body.UserSePridruzujeDaNe),r.addParameter("PkUsera",c.Int,e.body.PkUsera),r.addParameter("User",c.NVarChar,e.body.User),i.execStoredProc(r,t,a,"[]")}),n.post("/appUserInsert",async function(e,a){let t=null;try{if(!e.body.LoginName)return a.status(500).send({message:"STD:NO_USERNAME_PROVIDED"});{const r=await E(e.body,a);r&&(t=r.LoginName)}if(t==e.body.LoginName)return a.status(500).send({message:"STD:USERNAME_USED"});{const t=await U(e.body,a);return a.status(200).send(t)}}catch(e){a.status(500).send(e)}}),n.post("/resendConfirmEmail",async function(e,a){try{const{PkUsera:t}=e.body,r=await v(t,a),s=await p(r,a.locals.language);global.systemLogger.log({level:"info",message:"IMAP-GMAIL: "+JSON.stringify(s)}),a.status(200).send({message:"OK"})}catch(e){global.systemLogger.log({level:"info",message:"IMAP-GMAIL: "+JSON.stringify(e)}),a.status(500).send({...e,message:"STD:EMAIL_NO_SEND"})}}),n.post("/verifyAccount",async function(e,a){try{const t=await A(e.body.UUID,a);t?(await I({status:1,user:{...t,UserAktivanDaNe:1},res:a}),a.status(200).send(await A(e.body.UUID,a))):a.status(500).send({message:"STD:ACC_NO_CONFIRM"})}catch(e){a.status(500).send({...e,message:"STD:ACC_NO_CONFIRM"})}}),n.post("/findUserByUsername",async function(e,a){try{const t=await E(e.body,a);if(e.body.onlyAvatar&&t)return a.status(200).send({AvatarPath:t.AvatarPath});if(t)return a.status(200).send({ImeUsera:t.ImeUsera,PkUsera:t.PkUsera,PrezimeUsera:t.PrezimeUsera,Email:t.Email})}catch(e){a.status(500).send({...e,message:"STD:INVALID_CREDENTIALS"})}}),n.post("/sendPassChangeEmail",async function(e,a){if(e.body.PkUsera||e.body.LoginName){let t=null;try{e.body.LoginName?t=await E(e.body,a):e.body.PkUsera&&(t=await v(e.body.PkUsera,a))}catch(e){return a.status(500).send({...e,message:"STD:INVALID_REQUEST"})}if(!t)return a.status(500).send({message:"STD:INVALID_REQUEST"});try{await I({status:2,user:t,res:a});const e=await g(t,a.locals.language);global.systemLogger.log({level:"info",message:"IMAP-GMAIL: "+JSON.stringify(e)}),a.status(200).send({ImeUsera:t.ImeUsera,PkUsera:t.PkUsera,PrezimeUsera:t.PrezimeUsera,Email:t.Email})}catch(e){global.systemLogger.log({level:"info",message:"IMAP-GMAIL: "+JSON.stringify(e)}),a.status(500).send({...e,message:"STD:EMAIL_NO_SEND"})}}else a.status(500).send({message:"STD:NO_USERNAME_PROVIDED"})}),n.post("/resetForgottenPassword",async function(e,a){if(e.body.Lozinka)try{e.body.PkUsera?(await function(e,a){return new Promise(t=>{const r=i.createConnection(a.locals.currDatabase),s=i.createRequest("[Sigurnost].[spApplicationUserResetPassword]",r,a);s.addParameter("PkUsera",c.Int,o.decryptString(e.PkUsera)),s.addParameter("Lozinka",c.NVarChar,o.encryptString(e.Lozinka)),s.addParameter("RowVersion",c.NVarChar,e.RowVersion),i.execStoredProcFromNode(s,r,a,(e,a,r)=>{t(r[0])})})}({...await v(e.body.PkUsera,a),Lozinka:e.body.Lozinka},a),await I({status:1,user:await v(e.body.PkUsera,a),res:a}),a.status(200).send({message:"OK"})):a.status(500).send({message:"STD:PASS_ERROR_RESET"})}catch(e){a.status(500).send({message:"STD:PASS_ERROR_RESET"})}else a.status(500).send({message:"STD:NO_PASSWORD_PROVIDED"})}),n.post("/verifyCaptcha",async function(e,a){const t={url:"https://www.google.com/recaptcha/api/siteverify",form:{secret:e.body.captchaSecretKey,response:e.body.captchaToken}};s.post(t,(e,t,r)=>{e&&a.send(r),a.send(r)})}),n.post("/appUserUpdate",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationUser_update]",t,a);r.addParameter("PkUsera",c.Int,e.body.PkUsera),r.addParameter("PrezimeUsera",c.NVarChar,e.body.PrezimeUsera),r.addParameter("ImeUsera",c.NVarChar,e.body.ImeUsera),r.addParameter("LDAPLoginName",c.NVarChar,e.body.LDAPLoginName),r.addParameter("LoginName",c.NVarChar,e.body.LoginName),r.addParameter("ObaveznaIzmjenaLozinkeDaNe",c.Int,e.body.ObaveznaIzmjenaLozinkeDaNe),r.addParameter("Email",c.NVarChar,e.body.Email),r.addParameter("UserAktivanDaNe",c.Int,e.body.UserAktivanDaNe),r.addParameter("RowVersion",c.NVarChar,e.body.RowVersion),r.addParameter("PkUseraPromjena",c.Int,e.body.PkUseraPromjena),r.addParameter("User",c.NVarChar,e.body.User),i.execStoredProc(r,t,a,"[]")}),n.post("/appUserAktivanUpdate",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationUserAktivan_Update]",t,a);r.addParameter("KorisnikPkUsera",c.Int,e.body.KorisnikPkUsera),r.addParameter("AktivanDaNe",c.Bit,e.body.AktivanDaNe),r.addParameter("PkUsera",c.Int,e.body.PkUsera),r.addParameter("RowVersion",c.NVarChar,e.body.RowVersion),r.addParameter("User",c.NVarChar,e.body.User),i.execStoredProc(r,t,a,"[]")}),n.get("/userPravaApp",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spPravaKorisnika_select]",t,a);r.addParameter("PkUsera",c.Int,e.query.PkUsera),i.execStoredProc(r,t,a,"[]")}),n.post("/adminChangePasswordForUser",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationUser_AdminChangePassword]",t,a);r.addParameter("KorisnikPkUsera",c.Int,e.body.KorisnikPkUsera),r.addParameter("NovaLozinka",c.NVarChar,d.encryptString(e.body.NovaLozinka)),r.addParameter("PkUsera",c.Int,e.body.PkUsera),r.addParameter("RowVersion",c.NVarChar,e.body.RowVersion),r.addParameter("User",c.NVarChar,e.body.User),i.execStoredProc(r,t,a,"[]")}),n.post("/changePassword",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationUser_ChangePassword]",t,a);r.addParameter("KorisnikPkUsera",c.Int,e.body.KorisnikPkUsera),r.addParameter("StaraLozinka",c.NVarChar,d.encryptString(e.body.StaraLozinka)),r.addParameter("NovaLozinka",c.NVarChar,d.encryptString(e.body.NovaLozinka)),r.addParameter("PkUsera",c.Int,e.body.PkUsera),r.addParameter("User",c.NVarChar,e.body.User),i.execStoredProc(r,t,a,"[]")}),n.post("/usernameExists",function(e,a){const t=i.createConnection(a.locals.currDatabase),r=i.createRequest("[Sigurnost].[spApplicationUserLogin_select]",t,a);r.addParameter("LoginName",c.NVarChar,e.body.LoginName),i.execStoredProcFromNode(r,t,a,(e,t,r)=>{a.send({used:!!r.length})})}),e.exports={securityRouter:n,login:S,fetchUserByPk:v}},"./src/kripto.js":function(e,a,t){var r=t("crypto");let s={};const o={iv:"d6F3Efeqd6F3Efeq".toString("hex").slice(0,16),key:Buffer.from("d6F3Efeqd6F3Efeqd6F3Efeqd6F3Efeq".toString().slice(0,32),"utf8")};s.cfgKeyDecrypt=function(e){let a="";try{var t=r.createDecipheriv("aes-256-ctr",o.key,o.iv);a=t.update(e,"hex","utf8"),a+=t.final("utf8")}catch(a){global.systemLogger.log({level:"error",message:"Greška: dekripcija cfgKey: "+e+" : "+a.message})}return a},s.cfgKeyEncrypt=function(e){var a="";try{var t=r.createCipheriv("aes-256-ctr",o.key,o.iv);a=t.update(e,"utf8","hex"),a+=t.final("hex")}catch(a){global.systemLogger.log({level:"error",message:"Greška: enkripcija cfgKey: "+e+" : "+a.message})}return a};const n=s.cfgKeyDecrypt(global.appConfig.codes.delta),i={iv:s.cfgKeyDecrypt(global.appConfig.codes.alpha).toString("hex").slice(0,16),key:Buffer.from(s.cfgKeyDecrypt(global.appConfig.codes.beta).toString().slice(0,32),"utf8")};var u=s.encryptString=function(e){if(!(e&&""!==e&&null!==e&&void 0!==e&&e.length>0))return e;try{const a=r.createCipheriv(n,i.key,i.iv);let t=a.update(e,"utf8","hex");return t+=a.final("hex")}catch(a){return void global.systemLogger.log({level:"warn",message:"Greška u enkripciji stringa: "+e+" "+a.message})}},c=s.decryptString=function(e){if(!(e&&""!==e&&null!==e&&void 0!==e&&e.length>0))return e;try{const a=r.createDecipheriv(n,i.key,i.iv);let t=a.update(e,"hex","utf8");return t+=a.final("utf8")}catch(a){return void global.systemLogger.log({level:"warn",message:"Greška u dekripciji stringa: "+e+" "+a.message})}};s.tryDecryptOrReturnInput=function(e){if(!(e&&""!==e&&null!==e&&void 0!==e&&e.length>0))return e;try{const a=r.createDecipheriv(n,i.key,i.iv);let t=a.update(e,"hex","utf8");return t+=a.final("utf8")}catch(a){return e}};var d=s.dekriptirajPk=function(e){if(e){let a=[];global.appConfig.encryptionConfig.encryptColumns.forEach(e=>{a.push(e.toLowerCase())}),Object.keys(e).forEach(t=>{"object"==typeof e[t]&&null!==e[t]?d(e[t]):t&&a.includes(t.toLowerCase())&&(e[t]=c(e[t]))})}};s.encryptColumnsToClient=function(e){let a=!1;if(e&&e[0]){let t=[];global.appConfig.encryptionConfig.encryptColumns.forEach(e=>{t.push(e.toLowerCase())});for(const r of e){let e=Object.keys(r);if((e=e.filter(e=>t.includes(e.toLowerCase()))).forEach(e=>{if(e&&r[e]){let t=u(r[e].toString());t?r[e]=t:a=!0}}),a)break}}return 1==a?"NOK":e};s.decryptAdminPassword=function(e,a=!0){if(!(e&&""!==e&&null!==e&&void 0!==e&&e.length>3))return e;try{e=m(e);let t=new Date;const[s,o,u]=[t.getUTCMonth()+1,t.getUTCDate(),t.getUTCFullYear()];let c=s+o+u+i.key;const d=Buffer.from(c.toString().slice(0,32),"utf8"),l=r.createDecipheriv(n,d,i.iv);let P=l.update(e,"hex","utf8");return P+=l.final("utf8")}catch(t){return void(a&&global.systemLogger.log({level:"warn",message:"Greška u dekripciji stringa: "+e+" "+t.message}))}};let l=function(e,a){return[e.substring(0,a),e.substring(a)]},P=function(e){return l(e,1).map(e=>e+function(e){let a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".match(/./g),t="";for(var r=0;r<e;r++)t+=a[Math.floor(Math.random()*a.length)];return t}(4)).join("")},m=function(e){return l(e,1).map((e,a)=>1==a?e.slice(4,e.length-4):e).join("")};s.generateAdminPassword=function(e,a=!0){if(!(e&&""!==e&&null!==e&&void 0!==e&&e.length>3))return e;try{let t=new Date;const[s,o,u]=[t.getUTCMonth()+1,t.getUTCDate(),t.getUTCFullYear()];let c=s+o+u+i.key;const d=Buffer.from(c.toString().slice(0,32),"utf8"),l=r.createCipheriv(n,d,i.iv);let m=l.update(e,"utf8","hex");return m+=l.final("hex"),P(m)}catch(t){return void(a&&global.systemLogger.log({level:"warn",message:"Greška u enkripciji stringa: "+e+" "+t.message}))}},e.exports=s},"./src/mail/emails/sendAnketaLinkMail.js":function(e,a,t){const{mailInit:r,constructEmailOptions:s,sendMail:o,translate:n}=t("./src/mail/mailService.js"),i=t("path");e.exports={sendAnketaLinkMail:async function({user:e,lang:a,PkAnketa:t}){const{anketaLink:u}=global.appConfig.mailConfig.emails,{mailConfig:c}=global.appConfig,d=r(),l=s({lang:a,dest:{to:e.Email,subject:n(a,"ANKETA_LINK")},templateParams:{ANKETA_LINK:n(a,"ANKETA_LINK"),ANKETA_LINK_HEADER:n(a,"ANKETA_LINK_HEADER"),POSTOVANI:n(a,"POSTOVANI"),ime:e.ImeUsera,prezime:e.PrezimeUsera,ANKETA_LINK_TEXT_0:n(a,"ANKETA_LINK_TEXT_0"),link:`${u.url}/${t}`,ANKETA_BUTTON_LABEL:n(a,"ANKETA_BUTTON_LABEL"),ORG_NEED_HELP:n(a,"ORG_NEED_HELP"),ACC_CONFIRM_BACKUP_LINK:n(a,"ACC_CONFIRM_BACKUP_LINK"),organizationContactLink:c.incomingMailParams.organizationContactLink,staticUrl:c.incomingMailParams.staticUrl,ORGANIZATION:n(a,"ORGANIZATION"),ADDRESS:n(a,"ADDRESS"),appLink:c.incomingMailParams.appLink},templateUrl:i.join(u.template),attachments:u.attachments});return await o({mailTransport:d,options:l})}}},"./src/mail/emails/sendObavijestLinkMail.js":function(e,a,t){const{mailInit:r,constructEmailOptions:s,sendMail:o,translate:n}=t("./src/mail/mailService.js"),i=t("path");e.exports={sendObavijestLinkMail:async function({user:e,lang:a,PkObavijest:t}){const{obavijestLink:u}=global.appConfig.mailConfig.emails,{mailConfig:c}=global.appConfig,d=r(),l=s({lang:a,dest:{to:e.Email,subject:n(a,"OBAVIJEST_LINK")},templateParams:{OBAVIJEST_LINK:n(a,"OBAVIJEST_LINK"),OBAVIJEST_LINK_HEADER:n(a,"OBAVIJEST_LINK_HEADER"),POSTOVANI:n(a,"POSTOVANI"),ime:e.ImeUsera,prezime:e.PrezimeUsera,OBAVIJEST_LINK_TEXT_0:n(a,"OBAVIJEST_LINK_TEXT_0"),link:`${u.url}/${t}`,OBAVIJEST_BUTTON_LABEL:n(a,"OBAVIJEST_BUTTON_LABEL"),ORG_NEED_HELP:n(a,"ORG_NEED_HELP"),ACC_CONFIRM_BACKUP_LINK:n(a,"ACC_CONFIRM_BACKUP_LINK"),organizationContactLink:c.incomingMailParams.organizationContactLink,staticUrl:c.incomingMailParams.staticUrl,ORGANIZATION:n(a,"ORGANIZATION"),ADDRESS:n(a,"ADDRESS"),appLink:c.incomingMailParams.appLink},templateUrl:i.join(u.template),attachments:u.attachments});return await o({mailTransport:d,options:l})}}},"./src/mail/emails/sendPassResetMail.js":function(e,a,t){const r=t("path"),{mailInit:s,constructEmailOptions:o,sendMail:n,translate:i}=t("./src/mail/mailService.js");e.exports={sendPassResetEmail:async function(e,a){const{passReset:t}=global.appConfig.mailConfig.emails,{mailConfig:u}=global.appConfig,c=s(),d=o({lang:a,dest:{to:e.Email,subject:i(a,"RESET_PASSWORD")},templateParams:{RESET_PASSWORD:i(a,"RESET_PASSWORD"),RESET_PASSWORD_HEADER:i(a,"RESET_PASSWORD_HEADER"),POSTOVANI:i(a,"POSTOVANI"),ime:e.ImeUsera,prezime:e.PrezimeUsera,RESET_PASSWORD_TEXT_0:i(a,"RESET_PASSWORD_TEXT_0"),link:`${t.url}/${e.UUID}`,RESET_PASSWORD_BTN_LABEL:i(a,"RESET_PASSWORD_BTN_LABEL"),ORG_NEED_HELP:i(a,"ORG_NEED_HELP"),RESET_PASSWORD_BACKUP_LINK:i(a,"RESET_PASSWORD_BACKUP_LINK"),organizationContactLink:u.incomingMailParams.organizationContactLink,staticUrl:u.incomingMailParams.staticUrl,ORGANIZATION:i(a,"ORGANIZATION"),ADDRESS:i(a,"ADDRESS"),appLink:u.incomingMailParams.appLink},attachments:t.attachments,templateUrl:r.join(t.template)});return await n({mailTransport:c,options:d})}}},"./src/mail/emails/sendRegistrationMail.js":function(e,a,t){const{mailInit:r,constructEmailOptions:s,sendMail:o,translate:n}=t("./src/mail/mailService.js"),i=t("path");e.exports={sendRegistrationMail:async function(e,a){const{accConfirm:t}=global.appConfig.mailConfig.emails,{mailConfig:u}=global.appConfig,c=r(),d=s({lang:a,dest:{to:e.Email,subject:n(a,"CONFIRM_ACCOUNT")},templateParams:{CONFIRM_ACCOUNT:n(a,"CONFIRM_ACCOUNT"),CONFIRM_ACCOUNT_HEADER:n(a,"CONFIRM_ACCOUNT_HEADER"),POSTOVANI:n(a,"POSTOVANI"),ime:e.ImeUsera,prezime:e.PrezimeUsera,CONFIRM_ACCOUNT_TEXT_0:n(a,"CONFIRM_ACCOUNT_TEXT_0"),link:`${t.url}/${e.UUID}`,ACC_CONFIRM_BTN_LABEL:n(a,"ACC_CONFIRM_BTN_LABEL"),ORG_NEED_HELP:n(a,"ORG_NEED_HELP"),ACC_CONFIRM_BACKUP_LINK:n(a,"ACC_CONFIRM_BACKUP_LINK"),organizationContactLink:u.incomingMailParams.organizationContactLink,staticUrl:u.incomingMailParams.staticUrl,ORGANIZATION:n(a,"ORGANIZATION"),ADDRESS:n(a,"ADDRESS"),appLink:u.incomingMailParams.appLink},templateUrl:i.join(t.template),attachments:t.attachments});return await o({mailTransport:c,options:d})}}},"./src/mail/i18n/en.js":function(e,a){e.exports={ORGANIZATION:"Alumni",ADDRESS:"Stinice 12, 21000 Split",CONFIRM_ACCOUNT:"Account confirmation",CONFIRM_ACCOUNT_HEADER:"Account confirmation",POSTOVANI:"Dear",CONFIRM_ACCOUNT_TEXT_0:"With this email, we require that you verify your newly created account by clicking the following link.",PASS_CHANGE_BTN_LABEL:"Change Password",ACC_CONFIRM_BTN_LABEL:"Confirm Account",ORG_NEED_HELP:"Do you have a question? Contact us.",ACC_CONFIRM_BACKUP_LINK:"If you do not see the confirmation button, there is a confirmation link below.",RESET_PASSWORD:"Reset password",RESET_PASSWORD_HEADER:"Reset password",RESET_PASSWORD_TEXT_0:"With this email, we accept your password change request. You can reset your password by clicking the following link.",RESET_PASSWORD_BTN_LABEL:"Reset password",RESET_PASSWORD_BACKUP_LINK:"If you do not see the password reset button, there is a link below.",ANKETA_LINK:"We have a survey for you!",ANKETA_LINK_HEADER:"We have a survey for you!",ANKETA_LINK_TEXT_0:"With this email, we invite you to fill in our survey. It will take only a minute. Thank you in advance!",ANKETA_BUTTON_LABEL:"Continue to survey",OBAVIJEST_LINK:"We have a notification for you!",OBAVIJEST_LINK_HEADER:"We have a notification for you!",OBAVIJEST_LINK_TEXT_0:"With this email we notify you that you have new notification. Click on sent link to view notification. Thank you in advance!",OBAVIJEST_BUTTON_LABEL:"View notification"}},"./src/mail/i18n/hr.js":function(e,a){e.exports={ORGANIZATION:"Alumni",ADDRESS:"Stinice 12, 21000 Split",CONFIRM_ACCOUNT:"Potvrda korisničkog računa",CONFIRM_ACCOUNT_HEADER:"Potvrda korisničkog računa",POSTOVANI:"Poštovani/a",CONFIRM_ACCOUNT_TEXT_0:"Putem ovog e-maila zahtijevamo od vas da klikom na gore priložen gumb potvrdite vaš novokreirani korisnički račun.",PASS_CHANGE_BTN_LABEL:"Promijeni Lozinku",ACC_CONFIRM_BTN_LABEL:"Potvrdi Račun",ORG_NEED_HELP:"Imate li pitanje? Obratite nam se.",ACC_CONFIRM_BACKUP_LINK:"Ukoliko ne vidite gumb potvrde, ispod se nalazi poveznica za potvrdu.",RESET_PASSWORD:"Poništavanje lozinke",RESET_PASSWORD_HEADER:"Poništavanje lozinke",RESET_PASSWORD_TEXT_0:"Ovom e-poštom prihvaćamo vaš zahtjev za promjenom lozinke. Zaporku možete promijeniti klikom na gore priloženom gumbu.",RESET_PASSWORD_BTN_LABEL:"Poništi lozinku",RESET_PASSWORD_BACKUP_LINK:"Ukoliko ne vidite gumb za poništavanje lozinke, ispod se nalazi poveznica.",ANKETA_LINK:"Imamo anketu za vas!",ANKETA_LINK_HEADER:"Imamo anketu za vas!",ANKETA_LINK_TEXT_0:"Ovom e-poštom vas pozivamo da ispunite našu anketu. Trajat će samo minutu. Hvala unaprijed!",ANKETA_BUTTON_LABEL:"Nastavite do ankete",OBAVIJEST_LINK:"Imamo obavijest za vas!",OBAVIJEST_LINK_HEADER:"Imamo obavijest za vas!",OBAVIJEST_LINK_TEXT_0:"Ovom e-poštom vas obaviještavamo da imate novu notifikaciju. Pregled notifikacije možete izvršiti klikom na poslani link. Hvala unaprijed!",OBAVIJEST_BUTTON_LABEL:"Pregledajte obavijest"}},"./src/mail/mail.js":function(e,a,t){const{sendRegistrationMail:r}=t("./src/mail/emails/sendRegistrationMail.js"),{sendPassResetEmail:s}=t("./src/mail/emails/sendPassResetMail.js"),{sendAnketaLinkMail:o}=t("./src/mail/emails/sendAnketaLinkMail.js"),{sendObavijestLinkMail:n}=t("./src/mail/emails/sendObavijestLinkMail.js");e.exports={sendRegistrationMail:r,sendPassResetEmail:s,sendAnketaLinkMail:o,sendObavijestLinkMail:n}},"./src/mail/mailService.js":function(e,a,t){const r=t("nodemailer"),s=t("handlebars"),o=t("fs"),n=t("path"),i={hr:t("./src/mail/i18n/hr.js"),en:t("./src/mail/i18n/en.js")};function u(e,a){return i[e][a]}e.exports={mailInit:function(){const{incomingMailParams:e}=global.appConfig.mailConfig;let a={auth:{user:e.mailUser,pass:e.mailPass}};return"true"===e.mailServiceDaNe?a.service=e.mailService:(a.host=e.mailHost,a.port=e.mailPort,a.secure=!1,a.tls={rejectUnauthorized:!1}),r.createTransport(a)},translate:u,constructEmailOptions:function({lang:e,dest:{to:a,subject:t},templateParams:r,templateUrl:i,attachments:c}){const{mailConfig:d}=global.appConfig,l=o.readFileSync(n.join(i),"utf8"),P=s.compile(l);return{from:`${u(e,"ORGANIZATION")} <${d.incomingMailParams.mailUser}>`,to:a,subject:`Alumni | ${t}`,html:P(r),attachments:c}},sendMail:function({mailTransport:e,options:a}){return new Promise((t,r)=>{e.sendMail(a,(e,a)=>e?r(e):t(a))})}}},"./src/server.js":function(e,a,t){"use strict";var r=t("./src/config/appConfig.js"),s=t("body-parser"),o=t("helmet"),n=t("morgan"),i=t("./src/kripto.js"),u=t("express")(),c=t("express"),d=t("path"),l=t("./src/jwt/jwt.js");const{useGlobalAppHandlers:P}=t("./src/error.handler.js"),{handleRequestUser:m,isAdmin:k}=t("./src/services/app.service.js");var p=t("./src/winston.js");global.systemLogger=p.loggers.get("systemLogger"),global.apiLogger=p.loggers.get("apiLogger"),u.use(function(e,a,t){a.header("Access-Control-Allow-Origin","*"),a.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization, curr_db, language"),a.header("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),t()}),u.use(o()),u.use(s.json({limit:"5mb"})),u.use(s.urlencoded({limit:"5mb",extended:!0})),1==r.appLogParams.apiCallLog&&u.use(n(":status :date[iso] :method :url :response-time  :req[query] :req[body] :remote-addr :res[content-length]",{skip:function(e,a){return"OPTIONS"==e.method},stream:global.apiLogger.stream})),u.use(async function(e,a,t){a.locals.currDatabase=e.headers&&e.headers.curr_db||"Produkcijska baza podataka",a.locals.language=e.headers&&e.headers.language||"hr",global.appConfig.encryptionConfig.enkripcijaDaNe&&(i.dekriptirajPk(e.query),i.dekriptirajPk(e.body)),t()}),1==r.mainParams.checkAuthHeader&&u.use(l.jwtMiddleware()),u.use("/api/pretplata",t("./src/api/pretplate.js").pretplateRouter),u.use("/api/security",t("./src/jwt/security.js").securityRouter),u.use("/api/obavijesti",t("./src/api/obavijesti.js")),u.use("/api/profile",t("./src/api/profile.js")),u.use("/api/forum",t("./src/api/forum.js").forumRouter),u.use("/api/resursi",t("./src/api/resursi.js").resursiRouter),u.use("/api/ankete",t("./src/api/ankete.js").anketeRouter),u.use("/api/administracija",async(e,a,t)=>{"OPTIONS"==e.method?a.send(200):await k(e)?t():a.status(401).send({message:"STD:UNATHORIZED_ACCES"})},t("./src/api/administracija.js").administracijaRouter),u.use("/api",t("./src/api.js")),u.use("/api/google",t("./src/services/google.oauth2.service.js").router),u.use("/public/",c.static(d.join(r.directoryParams.nodeSrv,"public"))),u.use(function(e,a,t){global.systemLogger.log({level:"warn",message:"404 Unknown API URL: "+e.url});var r=new Error("Unknown API URL.");r.status=404,t(r)}),u.use(function(e,a,t,s){r.ukljuciConsoleLog.ukljuciStackTrace&&console.trace(e),global.systemLogger.log({level:"error",message:"ERROR: "+e.message+e.status}),s(e),t.status(e.status||500).end()}),r.ukljuciConsoleLog.ukljuciStackTrace&&P(),u.get("*",function(e,a){global.systemLogger.log({level:"warn",message:"Nepoznati API URL ! "+e.url}),a.status(404).send("Nepoznati API URL !")}),e.exports=u,u.listen(r.mainParams.applicationPort),global.systemLogger.log({level:"info",message:"Server started at port "+r.mainParams.applicationPort})},"./src/services/ankete.service.js":function(e,a,t){const{TYPES:r}=t("tedious"),{constructConnection:s,makeObservableConnectionWithOutput:o,makeObservableConnection:n,exists:i}=t("./src/services/app.service.js");e.exports={insertPredlozakWithOutput:function({predlozak:e,user:a,res:t,db:n}){const{PredlozakNaziv:i,PredlozakNaslov:u,PredlozakOpis:c,ProglasenoAnketomDaNe:d}=e,{request:l,conn:P}=s("Ankete.spPredlozak_upsert",t.locals.currDatabase,t,n);return l.addParameter("PredlozakNaziv",r.NVarChar,i),l.addParameter("PredlozakNaslov",r.NVarChar,u),l.addParameter("PredlozakOpis",r.NVarChar,c),l.addParameter("IzbrisanDaNe",r.Int,0),l.addParameter("UredivanjeDaNe",r.Int,1),l.addParameter("PkUserUnos",r.Int,a.PkUsera),l.addParameter("PkUsera",r.Int,a.PkUsera),l.addParameter("PkUserPromjena",r.Int,a.PkUsera),l.addParameter("User",r.NVarChar,a.ImePrezimeUsera),l.addParameter("ProglasenoAnketomDaNe",r.Int,d),l.addOutputParameter("PkPredlozak",r.Int,null),o(l,P,t,n,"PkPredlozak")},updatePredlozakWithOutput:function({predlozak:e,PkPredlozak:a,user:t,res:n,db:i}){const{PredlozakNaziv:u,PredlozakNaslov:c,PredlozakOpis:d,IzbrisanDaNe:l,UredivanjeDaNe:P,PkUserUnos:m,DatumUnos:k,PkUsera:p,ProglasenoAnketomDaNe:g}=e,{request:b,conn:f}=s("Ankete.spPredlozak_upsert",n.locals.currDatabase,n,i);return b.addParameter("PredlozakNaziv",r.NVarChar,u),b.addParameter("PredlozakNaslov",r.NVarChar,c),b.addParameter("PredlozakOpis",r.NVarChar,d),b.addParameter("IzbrisanDaNe",r.Int,l),b.addParameter("UredivanjeDaNe",r.Int,P),b.addParameter("PkUserUnos",r.Int,m),b.addParameter("PkUsera",r.Int,p),b.addParameter("DatumUnos",r.Date,k),b.addParameter("PkUserPromjena",r.Int,t.PkUsera),b.addParameter("User",r.NVarChar,t.ImePrezimeUsera),b.addParameter("ProglasenoAnketomDaNe",r.Int,g),b.addOutputParameter("PkPredlozak",r.Int,a),o(b,f,n,i,"PkPredlozak")},insertPitanjePredlozak:function({PkPitanje:e,PkPredlozak:a,pitanje:t,user:n,res:i,db:u}){const{request:c,conn:d}=s("Ankete.spPredlozakPitanje_Insert",i.locals.currDatabase,i,u),{PitanjeRedoslijed:l}=t;return c.addParameter("PkPredlozak",r.Int,a),c.addParameter("PkPitanje",r.Int,e),c.addParameter("PitanjeRedoslijed",r.Int,l),c.addParameter("PkUser",r.Int,n.PkUsera),c.addParameter("User",r.NVarChar,n.ImePrezimeUsera),c.addOutputParameter("PkPredlozakPitanje",r.Int,null),o(c,d,i,u,"PkPredlozakPitanje")},groupStats:function(e){const a=[];return e.forEach(e=>{let t=a.find(a=>a.PkPitanje==e.PkPitanje);t?t.Odgovori.push(e):a.push({PkPitanje:e.PkPitanje,Odgovori:[e]})}),a},fetchAnketaStatistika:function({PkAnketa:e=null,PkPredlozak:a=null,db:t,res:o}){const{request:u,conn:c}=s("Ankete.[spStatistikaAnketa_select]",o.locals.currDatabase,o,t);return i(e)&&u.addParameter("PkAnketa",r.Int,e),i(a)&&u.addParameter("PkPredlozak",r.Int,a),n(u,c,o,t)},fetchAnketaStatistikaPitanja:function({PkAnketa:e=null,PkPredlozak:a=null,db:t,res:o}){const{request:u,conn:c}=s("Ankete.[spStatistikaAnketaPitanjaOdgovor_select]",o.locals.currDatabase,o,t);return i(e)&&u.addParameter("PkAnketa",r.Int,e),i(a)&&u.addParameter("PkPredlozak",r.Int,a),n(u,c,o,t)}}},"./src/services/app.service.js":function(e,a,t){const r=t("axios").default,s=1e3,o=t("path"),n=t("fs"),i=t("./src/kripto.js"),{from:u}=t("rxjs");function c(e){if(!e)return{};const a=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),t=decodeURIComponent((r=a,Buffer.from(r,"base64").toString("binary")).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""));var r;return JSON.parse(t)}async function d(e,a){const t=e.user;if(t){const{payload:e}=t;return e.PkUsera&&(e.PkUsera=+i.decryptString(e.PkUsera)),e}if(e.headers&&e.headers.authorization){const{payload:a}=c(e.headers.authorization);return a.PkUsera&&(a.PkUsera=+i.decryptString(a.PkUsera)),a}return{}}e.exports={simpleDbResolve:function(e,a,t,r,s="STD:INVALID_REQUEST"){return"OK"==e?r.status(200).send(t):r.status(500).send({message:s})},dbResolveMiddleware:async function(e,a,t){"OPTIONS"!=e.method&&(await async function(e,a=!1){const{productionDatabaseServer:t,testDatabaseServer:o}=global.appConfig.databaseParams;try{const n=()=>"Produkcijska baza podataka"==e?t:o,i=`${(()=>a?"https://":"http://")()}${n()}`;return await r.get(i,{timeout:s}),{}}catch(e){const{response:a}=e;return a&&a.status?{error:!0}:{error:null}}}(a.locals.currDatabase,e.secure)).error?a.status(503).send({message:"STD:CHECK_INTERNET_OR_VPN"}):t()},constructDirDepth:function(e,a=null){const{directoryParams:t}=global.appConfig;return e.reduce((e,a)=>{const t=o.join(e,a);return n.existsSync(t)||n.mkdirSync(t),t},a?o.join(a):o.join(t.nodeSrv))},handleRequestUser:d,exists:function(e){return"[object Object]"!==e&&!["null","undefined"].includes(e)&&!!e},groupDataByKeySync:function(e,a){return e.reduce((e,t)=>void 0===t[a]?e:Object.assign(e,{[t[a]]:(e[t[a]]||[]).concat(t)}),{})},groupByProperties:function(e,a){let t=[];return e.forEach(function(e){t.some(function(t){let r=a.every(function(a){return t[0][a]===e[a]});return r&&t.push(e),r})||t.push([e])}),t},decryptIfEncrypted:function(e){return i.tryDecryptOrReturnInput(e)},devLogger:function(){return new console.Console(n.createWriteStream("./output.txt"))},groupFlatProperies:function(e,a={}){return function(e,a){for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&a(t,e[t])}(e,function(e,t){e=e.split(".");let r=a;for(let a=0;a<e.length;a++){let s=e[a];void 0===r[s]&&(a===e.length-1?r[s]=t:/^\+?(0|[1-9]\d*)$/.test(e[a+1])?r[s]=[]:r[s]={}),r=r[s]}}),a},constructConnection:(e,a,t,r)=>{const s=r.createConnection(a);return{request:r.createRequest(e,s,t),conn:s}},makeObservableConnection:(e,a,t,r)=>u(new Promise(s=>{r.execStoredProcFromNode(e,a,t,(e,a,t)=>{"OK"==e&&s(t),s([])})})),makeObservableConnectionWithOutput:(e,a,t,r,s)=>u(new Promise(o=>{r.execStoredProcFromNode(e,a,t,(e,a,t)=>{"OK"==e&&o(s in a?{[s]:a[s]}:{[s]:null}),o({[s]:null})})})),flatten:e=>[].concat.apply([],e),stringToSentence:e=>e&&(e=(e=e.replace(/\s+/g," ").trim())[0].toUpperCase()+e.slice(1)).length?e.endsWith(".")?e:e+".":null,hasClaim:async function({modul:e,claim:a},t){const r=await d(t);if(!r)return!1;if(r.IsAdmin)return!0;if(!r.Claims)return!1;try{return JSON.parse(r.Claims)[e][a]}catch(e){return!1}},isAdmin:async function(e){const a=await d(e);return!(!a||!a.IsAdmin)}}},"./src/services/google.oauth2.service.js":function(e,a,t){const{google:r}=t("googleapis"),s=t("axios").default,o=t("express").Router(),{google:n}=global.appConfig.oauth,i=new r.auth.OAuth2(n.GOOGLE_CLIENT_ID,n.GOOGLE_CLIENT_SECRET,n.redirectUrl);async function u({code:e}){const{tokens:a}=await i.getToken(e);return await s.get(`https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token=${a.access_token}`,{headers:{Authorization:`Bearer ${a.id_token}`}}).then(e=>e.data).catch(e=>{throw new Error(e.message)})}o.get("/oauth/complete",async(e,a)=>{try{const t=await u(e.query);a.send(t)}catch(e){a.status(500).send({...e,message:"STD:GOOGLE_AUTH_ERROR"})}}),o.get("/oauth",async(e,a)=>{a.send({url:i.generateAuthUrl({access_type:"offline",prompt:"consent",scope:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email"]})})}),e.exports={getGoogleUser:u,router:o}},"./src/services/profile.service.js":function(e,a,t){const r=t("./src/db.js"),{TYPES:s}=t("tedious"),{exists:o}=t("./src/services/app.service.js");e.exports={createUpsertOsobniPodaciRequest:function(e,a){const t=r.createConnection(a.locals.currDatabase),o=r.createRequest("Alumni.[spOsobniPodaci_Upsert]",t,a);return o.addParameter("Spol",s.NVarChar,e.body.Spol),o.addParameter("ImeUsera",s.NVarChar,e.body.ImeUsera),o.addParameter("PrezimeUsera",s.NVarChar,e.body.PrezimeUsera),o.addParameter("DatumRodenja",s.NVarChar,e.body.DatumRodenja),o.addParameter("OIB",s.NVarChar,e.body.OIB),o.addParameter("JMBAG",s.NVarChar,e.body.JMBAG),o.addParameter("PkDrzava",s.NVarChar,e.body.PkDrzava),o.addParameter("Grad",s.NVarChar,e.body.Grad),o.addParameter("Adresa",s.NVarChar,e.body.Adresa),e.body.Email&&o.addParameter("Email",s.NVarChar,e.body.Email),o.addParameter("Mobitel",s.NVarChar,e.body.Mobitel),e.body.LDAPLoginName&&o.addParameter("LDAPLoginName",s.NVarChar,e.body.LDAPLoginName),o.addParameter("PkUsera",s.Int,e.body.PkUsera),o.addParameter("PrivatnostPodataka",s.Bit,e.body.PrivatnostPodataka),o.addOutputParameter("PkOsobniPodaciPkUsera",s.Int,e.body.PkOsobniPodaciPkUsera),{request:o,conn:t}},createDatotekaInsertRequest:function({Naziv:e,Opis:a,PkDatoteka:t,originalname:n,encoding:i,size:u,mimetype:c,destination:d,filename:l,path:P,PkUseraUnos:m,PkUseraPromjena:k,UserUnos:p,UserPromjena:g},b){const f=r.createConnection(b.locals.currDatabase),D=r.createRequest("Alumni.[spDatoteka_insert]",f,b);return D.addParameter("originalname",s.NVarChar,n),D.addParameter("encoding",s.NVarChar,i),D.addParameter("size",s.Int,u),D.addParameter("mimetype",s.NVarChar,c),D.addParameter("destination",s.NVarChar,d),D.addParameter("filename",s.NVarChar,l),D.addParameter("path",s.NVarChar,P),D.addParameter("PkUseraUnos",s.Int,m),D.addParameter("PkUseraPromjena",s.Int,k),D.addParameter("UserUnos",s.NVarChar,p),D.addParameter("UserPromjena",s.NVarChar,g),D.addParameter("Naziv",s.NVarChar,e),D.addParameter("Opis",s.NVarChar,a),D.addOutputParameter("PkDatoteka",s.Int,o(t)?t:null),{request:D,conn:f}},createDatotekaRelacijaRequest:function({PkForumObjava:e,PkResursObjava:a,PkUsera:t,PkDatoteka:o,PkDatotekaCoverImage:n,PkForumObjavaKomentar:i=null,PkResursObjavaKomentar:u=null},c){const d=r.createConnection(c.locals.currDatabase),l=r.createRequest("Alumni.[spDatotekaRelacija_insert]",d,c);return e&&l.addParameter("PkForumObjava",s.Int,e),a&&l.addParameter("PkResursObjava",s.Int,a),t&&l.addParameter("PkUsera",s.Int,t),o&&l.addParameter("PkDatoteka",s.Int,o),n&&l.addParameter("PkDatotekaCoverImage",s.Int,n),i&&l.addParameter("PkForumObjavaKomentar",s.Int,i),u&&l.addParameter("PkResursObjavaKomentar",s.Int,u),{request:l,conn:d}},fetchDatotekaInfo:function({PkDatoteka:e},a){return new Promise((t,o)=>{const n=r.createConnection(a.locals.currDatabase),i=r.createRequest("Alumni.spDatotekaRelacija_select",n,a);i.addParameter("PkDatoteka",s.Int,e),r.execStoredProcFromNode(i,n,a,(e,a,r)=>{"OK"==e?t(r):o("STD:INVALID_REQUEST")})})},deletePrilog:function(e,a){return new Promise((t,o)=>{const n=r.createConnection(a.locals.currDatabase),i=r.createRequest("Alumni.spDatoteka_delete",n,a);i.addParameter("PkDatoteka",s.Int,e.PkDatoteka),i.addParameter("PkDatotekaCoverImage",s.Int,e.PkDatotekaCoverImage),r.execStoredProcFromNode(i,n,a,(e,a,r)=>{"OK"==e?t(r):o("STD:INVALID_REQUEST")})})}}},"./src/tools.js":function(e,a,t){const r=t("fs");e.exports={cleanUpFileName:function(e){for(var a=[{base:"_",letters:/[\u003E\uFE65\uFF1E\u003C\uFE64\uFF1C\u003A\u003F\u002A\u003D\u002B\u0023]/g}],t=0;t<a.length;t++)e=e.replace(a[t].letters,a[t].base);return e},removeDiacritics:function(e,a=!1){var t=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];if(e)if(a)for(let a=0;a<e.length;a++)void 0!=t.find(t=>e[a].match(t.letters)&&t.base!=e[a])&&(e=e.substring(0,a)+e.substring(a+1));else for(let a=0;a<t.length;a++)e=e.replace(t[a].letters,t[a].base);return e},checkFolderExists:function(e){try{return r.statSync(e),!0}catch(e){return!1}},checkFileExists:function(e){try{return r.statSync(e),!0}catch(e){return!1}},pripremiFoldere:function(){r.exists(global.appConfig.directoryParams.uploadPath,function(e){e||r.mkdir(global.appConfig.directoryParams.uploadPath,function(e){e&&global.systemLogger.log({level:"error",message:"tools.pripremiFoldere(): Error in  uploadPath folder creation "})})}),r.exists(global.appConfig.directoryParams.uploadPathTest,function(e){e||r.mkdir(global.appConfig.directoryParams.uploadPathTest,function(e){})}),r.exists(global.appConfig.directoryParams.nodeSrv+"logs",function(e){e||r.mkdir(global.appConfig.directoryParams.nodeSrv+"logs",function(e){})})}}},"./src/winston.js":function(e,a,t){const r=t("winston"),{format:s}=t("winston"),{combine:o,timestamp:n,label:i,json:u,printf:c}=s,d=c(({level:e,message:a,label:t,timestamp:r})=>`${r} [${t}] ${e}: ${a}`);r.loggers.add("apiLogger",{format:o(i({label:"ApiLog"}),n(),d,s.json()),transports:[new r.transports.File({filename:global.appConfig.appRootPath+"/logs/api-logs.log",json:!1,maxsize:5242880,maxFiles:5}),new r.transports.Console]}),r.loggers.add("systemLogger",{format:o(i({label:"SystemLog"}),n(),d,s.json()),transports:[new r.transports.File({filename:global.appConfig.appRootPath+"/logs/system-logs.log",json:!1,maxsize:5242880,maxFiles:5}),new r.transports.Console]}),r.loggers.get("apiLogger").stream={write:function(e,a){global.apiLogger.info(e)}},e.exports=r.loggers},activedirectory2:function(e,a){e.exports=require("activedirectory2")},"app-root-path":function(e,a){e.exports=require("app-root-path")},axios:function(e,a){e.exports=require("axios")},"body-parser":function(e,a){e.exports=require("body-parser")},crypto:function(e,a){e.exports=require("crypto")},express:function(e,a){e.exports=require("express")},"express-jwt":function(e,a){e.exports=require("express-jwt")},formidable:function(e,a){e.exports=require("formidable")},fs:function(e,a){e.exports=require("fs")},"fs-extra":function(e,a){e.exports=require("fs-extra")},googleapis:function(e,a){e.exports=require("googleapis")},handlebars:function(e,a){e.exports=require("handlebars")},helmet:function(e,a){e.exports=require("helmet")},jsonwebtoken:function(e,a){e.exports=require("jsonwebtoken")},morgan:function(e,a){e.exports=require("morgan")},nodemailer:function(e,a){e.exports=require("nodemailer")},path:function(e,a){e.exports=require("path")},process:function(e,a){e.exports=require("process")},request:function(e,a){e.exports=require("request")},rxjs:function(e,a){e.exports=require("rxjs")},tedious:function(e,a){e.exports=require("tedious")},"tedious-connection-pool":function(e,a){e.exports=require("tedious-connection-pool")},uuidv4:function(e,a){e.exports=require("uuidv4")},winston:function(e,a){e.exports=require("winston")}});
//# sourceMappingURL=Alumni.js.map